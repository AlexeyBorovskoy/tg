# База данных: tg.messages

## 1. Назначение
`tg.messages` — базовая таблица хранения сообщений Telegram, полученных из чатов/каналов.

Таблица предназначена для:
- долговременного хранения;
- построения инкрементальной обработки (по msg_id/dt);
- последующей векторизации и построения RAG-индекса (на следующих этапах проекта).

## 2. Поля (фактическая структура стенда)
| № | Поле        | Тип данных                     | Назначение |
|---:|------------|--------------------------------|-----------|
| 1 | id          | bigint                         | внутренний PK |
| 2 | peer_type   | text                           | тип peer: channel/chat |
| 3 | peer_id     | bigint                         | идентификатор peer |
| 4 | msg_id      | bigint                         | идентификатор сообщения в рамках peer |
| 5 | dt          | timestamp with time zone       | время сообщения (UTC) |
| 6 | sender_id   | bigint                         | id отправителя |
| 7 | sender_name | text                           | имя отправителя (как получено) |
| 8 | text        | text                           | текст сообщения |
| 9 | raw_json    | jsonb                          | сырой JSON (для форензики/восстановления) |

## 3. Индексы (фактические)
- `messages_pkey` (id)
- `messages_peer_type_peer_id_msg_id_key` (unique) по (peer_type, peer_id, msg_id)
- `idx_tg_messages_peer` по (peer_type, peer_id, msg_id)
- `idx_tg_messages_dt` по (dt)

## 4. Принципы фильтрации для аналитики
Для генерации документации по выбранному чату применяется фильтр:
- `peer_type = 'channel' AND peer_id = <целевой>`

Тестовые данные (например `peer_id=-1`) исключаются за счёт фильтрации.
