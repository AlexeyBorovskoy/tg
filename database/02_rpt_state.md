# База данных: курсоры обработки (rpt.*)

## 1. Назначение
Схема `rpt` хранит состояние инкрементальной обработки:
- какой msg_id уже обработан для выбранного peer;
- какие файлы отчётов уже сформированы (для предотвращения повторов).

## 2. Таблицы (фактические)
### 2.1. rpt.report_state
Назначение: курсор ingest/выгрузки (что уже прочитано из источника).

Ключевые поля (фактические):
- peer_type
- peer_id
- last_msg_id
- updated_at

### 2.2. rpt.llm_report_state
Назначение: курсор формирования LLM-отчётов (что уже отражено в документации).

Ключевые поля (фактические):
- peer_type
- peer_id
- last_raw_file (может быть пустым на текущем стенде)
- last_msg_id
- updated_at

## 3. Принцип работы
- При каждом цикле обработки выбираются сообщения `msg_id > last_msg_id` для конкретного `(peer_type, peer_id)`.
- После успешной публикации результатов курсор обновляется.
- Если новых сообщений нет — публикация слота/дня не выполняется.

## 4. Синхронизация курсоров (операция обслуживания)
При ручной догонке состояния (например после тестов) `last_msg_id` может быть синхронизирован с текущим `max(msg_id)` в `tg.messages` по целевому peer.
