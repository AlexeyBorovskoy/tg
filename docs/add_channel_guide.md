# Руководство по добавлению новых чатов

## Автоматическое добавление чата в систему мониторинга

Система поддерживает автоматическое добавление новых чатов с полной загрузкой истории и созданием сводного документа.

---

## Быстрый старт

### 1. Добавление чата через скрипт

```bash
cd ~/tg_digest_system/tg_digest_system
source ../.venv/bin/activate
set -a && source .env && set +a

# Простой вариант (автоматически определит тип и название)
python scripts/add_channel.py <CHAT_ID>

# С указанием получателя
python scripts/add_channel.py <CHAT_ID> --recipient-id 123456789 --recipient-name "Имя Фамилия"

# С выбором промпта
python scripts/add_channel.py <CHAT_ID> --prompt prompts/asudd_main.md
```

### 2. Через обёртку (bash)

```bash
cd ~/tg_digest_system/tg_digest_system
./scripts/add_channel.sh <CHAT_ID>
```

---

## Что делает скрипт

1. **Определяет тип чата** (channel/group/chat) и название
2. **Загружает всю историю**:
   - Все сообщения из чата
   - Все медиафайлы
   - Обработка OCR для изображений
3. **Создаёт сводный инженерный документ** на основе всех сообщений
4. **Добавляет канал в конфигурацию** (`config/channels.json`)
5. **Индексирует в RAG** для семантического поиска
6. **Отправляет уведомление** в Telegram о завершении

---

## Параметры

| Параметр | Описание | Обязательный |
|----------|----------|--------------|
| `chat_id` | Telegram ID чата | ✅ Да |
| `--name` | Название чата | Нет (определится автоматически) |
| `--prompt` | Файл промпта для дайджестов | Нет (по умолчанию: `prompts/digest_management.md`) |
| `--recipient-id` | Telegram ID получателя | Нет (используется владелец сессии) |
| `--recipient-name` | Имя получателя | Нет |
| `--config` | Путь к channels.json | Нет (по умолчанию: `config/channels.json`) |

---

## Примеры использования

### Пример 1: Добавление группы

```bash
python scripts/add_channel.py 5228538198
```

Результат:
- Определит что это группа
- Загрузит все 86 сообщений
- Обработает медиафайлы
- Создаст `docs/reference/obu_pat_get_dodd_asu_lte.md`
- Добавит в конфигурацию

### Пример 2: Добавление канала с несколькими получателями

Сначала добавьте канал, затем отредактируйте `config/channels.json` вручную для добавления получателей.

### Пример 3: Использование специального промпта

```bash
python scripts/add_channel.py -1001234567890 \
  --prompt prompts/controllers.md \
  --recipient-id 499412926
```

---

## Автоматическое обнаружение новых каналов

После добавления канала в `config/channels.json`:

- ✅ **Воркер автоматически обнаружит** новый канал при следующем цикле (каждые 30-60 минут)
- ✅ **Не требуется перезапуск** сервиса
- ✅ **Начнётся мониторинг** новых сообщений автоматически

---

## Структура создаваемых файлов

```
docs/reference/
└── <название_чата>.md          # Сводный инженерный документ

config/
└── channels.json                # Обновлённая конфигурация
```

---

## Проверка статуса

После добавления проверьте:

```bash
# Логи сервиса
sudo journalctl -u tg_digest_worker -f

# Конфигурация
cat config/channels.json | python3 -m json.tool

# Статистика в БД
psql -d tg_digest -c "SELECT peer_id, COUNT(*) FROM tg.messages GROUP BY peer_id;"
```

---

## Устранение проблем

### Ошибка: "Chat not found"

**Причина**: Аккаунт не состоит в чате или неверный ID

**Решение**:
1. Убедитесь что ваш аккаунт — участник чата
2. Проверьте ID через `@RawDataBot` или веб-версию Telegram

### Ошибка: "Permission denied"

**Причина**: Нет прав на запись в `config/channels.json`

**Решение**:
```bash
chmod 664 config/channels.json
```

### Медленная загрузка истории

**Причина**: Большое количество сообщений

**Решение**: Это нормально. Скрипт показывает прогресс каждые 100 сообщений. Для больших чатов (1000+ сообщений) процесс может занять 10-30 минут.

---

## Интеграция с Telegram ботом (будущее)

Планируется добавить команды бота:
- `/add_channel <chat_id>` — добавить чат
- `/list_channels` — список каналов
- `/remove_channel <chat_id>` — удалить канал

---

## Технические детали

- Скрипт использует Telethon для доступа к Telegram API
- Все данные сохраняются в PostgreSQL (`tg.messages`, `tg.media`, `tg.media_text`)
- Сводный документ генерируется через OpenAI GPT
- Индексация в RAG через pgvector (схема `vec`)
