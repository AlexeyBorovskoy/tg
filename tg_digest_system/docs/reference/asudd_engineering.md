# Инженерный журнал — Ext Яндекс ЕПУТС СПб светофоры  
Обновлено: **2026‑02‑03** · источник: сообщения, OCR (БД)

---

## 1. Архитектура и интеграция  

### 1.1. Общая архитектура системы  

| Слой | Компонент | Описание | Примечание |
|------|-----------|----------|------------|
| **Клиент** | Яндекс Навигация | Запрашивает данные о светофорах, отображает таймеры, планирует маршруты. | Использует API `tlc.ripas.ru` (msg_id=803, 842). |
| **Промежуточный** | API‑шлюз `tlc.ripas.ru` | Преобразует запросы Яндекса в запросы к дорожной платформе, обеспечивает аутентификацию (Bearer‑токен). | Доступ к Swagger‑спецификации ограничен (msg_id=842‑844). |
| **Данные** | Дорожные контроллеры (ДК) | Генерируют события смены фаз и сигнальных групп (SG), публикуют их в SSE‑поток. Типы ДК: **Spectr**, **Spectr2**, **CrossAdapter**, **UK GEAR**, **RUKON** (msg_id=800‑805, 822‑825, 1174‑1176). |
| **Сервис** | `tlc` API | REST‑эндпоинты: `get_dynamic_program`, `get_last_configuration`, `status`, `get_sg_data`, `event_stream`, `auth/login`. | Swagger‑спецификация доступна только в виде статических файлов (OCR `msg_id=186`). |
| **Хранилище** | PostgreSQL | Сохраняет конфигурации, события, метрики. Таблицы: `tlc_config`, `tlc_events`, `tlc_metrics`. |
| **Мониторинг** | Grafana + Prometheus | Сбор метрик: задержки, потеря пакетов, нагрузка, синхронизация времени. | Метрики публикуются через `/metrics` (msg_id=1288). |

**Трафик**  
* SSE‑поток (`/tlc/event_stream`) – ~1 000 св. ф. с событиями, ≈10 KB/s (msg_id=822).  
* REST‑запросы – 200 запросов/мин (msg_id=823).  

**Синхронизация времени**  
* ДК синхронизируются по NTP, однако наблюдаются расхождения от 0 с до >10 с (msg_id=1053‑1055, 1084‑1092, 1105‑1107).  
* Время события фиксируется в поле `original_event_time` (msg_id=822).  

### 1.2. API‑взаимодействие  

| Эндпоинт | Метод | Параметры | Описание | Пример ответа | Сообщения |
|----------|-------|-----------|----------|---------------|-----------|
| `/tlc/{tlc_id}/get_dynamic_program` | GET | `tlc_id` | Текущая динамическая программа (StageRing / Fixed). | `{ "id":1, "name":"Программа.1", "algorithm":{ "type":"StageRing", "sequence":[1,2], "cycle":110, "coordinated":true, "offset":100, "phases":[...] } }` | 896‑898 |
| `/tlc/{tlc_id}/get_last_configuration` | GET | `tlc_id` | Последняя конфигурация (SignalGroup, connections). | JSON‑структура с массивом `SignalGroup`. | 1174‑1176, 1156 |
| `/tlc/{tlc_id}/status` | GET | `tlc_id` | Текущее состояние ДК, включая время контроллера. | `{ "status":"OK", "time":"2026-01-14T17:19:25Z" }` | 1053 |
| `/tlc/get_sg_data` | GET | `tlc_id`, `start_time`, `end_time` | Набор сигнальных групп за период. | `[{"id":1,"name":"1","directionId":12},...]` | 823 |
| `/tlc/event_stream` | SSE | – | Поток событий смены фаз/SG. | `data: {"tlc_id":2338,"directionId":12,"signal":"yellow","time":"2026-01-14T17:19:25Z"}` | 822 |
| `/api/v1/auth/login` | POST | `username`, `password` | Аутентификация, выдача Bearer‑токена (TTL = 1 ч). | `{ "access_token":"...", "expires_in":3600 }` | 1286‑1291 |
| `/tlc/cnf_storage/{tlo_id}/get_last_configuration` | GET | `tlo_id` | Альтернативный эндпоинт (часто 403). | 403 Forbidden (CrossAdapter) | 1156 |
| `/tlc/{tlc_id}/get_dynamic_program` (повтор) | GET | `tlc_id` | Доступ ограничен для некоторых контроллеров. | 403 Forbidden | 1156 |

**Аутентификация** – Bearer‑токен, обновляется автоматически (msg_id=1286‑1291).  

**Ограничения доступа** – 403 для контроллеров **CrossAdapter**, **RUKON**, а также для эндпоинтов `cnf_storage` (msg_id=1156, 1174‑1176).  

### 1.3. Роли сторон и ответственность  

| Сторона | Роль | Ответственность |
|----------|------|-----------------|
| **Яндекс** | Интегратор | Формирует запросы к API, обрабатывает SSE, отображает таймеры, реализует бизнес‑логику (msg_id=803, 822‑825). |
| **РИПАС** | Поставщик API | Обеспечивает доступ к эндпоинтам, поддерживает токены, отвечает за синхронизацию времени ДК, фиксирует ограничения доступа (msg_id=842‑844, 1053‑1055). |
| **ДК** (Spectr, Spectr2, CrossAdapter, UK GEAR, RUKON) | Источник данных | Генерируют события, публикуют их в SSE, хранят конфигурацию, синхронизируют часы (msg_id=800‑805, 822‑825, 1174‑1176). |
| **ДОДД** | Мониторинг нагрузки | Управляет подписками, собирает метрики, контролирует нагрузку и дисковое пространство (msg_id=1085‑1089, 1105‑1107). |
| **Тестовые стенды** | Тестирование | Предоставляют Swagger‑спецификацию, позволяют проверять интеграцию без риска (msg_id=842‑844). |

### 1.4. Изменения архитектуры за период  

| Дата | Изменение | Причина | Последствия |
|------|-----------|---------|-------------|
| 2025‑12‑08 | Восстановлен доступ к `tlc.ripas.ru/docs`. | Ошибка в конфигурации сервера. | Пользователи получили документацию (msg_id=803). |
| 2025‑12‑12 | Ограничен доступ к Swagger, переход на статическую спецификацию. | Политика безопасности. | 403 для некоторых эндпоинтов (msg_id=842‑844). |
| 2026‑01‑14 | План синхронизации часов ДК. | Наблюдаемые расхождения (см. 1053‑1055). | Запуск мониторинга drift, подготовка автоматической синхронизации. |
| 2026‑01‑27 | Вывод из эксплуатации контроллеров **RUKON** (SG не передаются). | Протокол OCIT не поддерживает SG. | Планируется замена контроллеров (msg_id=1174‑1176). |
| 2026‑01‑31 | Перезапуск серверов граберов, восстановление SSE‑потока. | Ошибки 504/403 при авторизации (msg_id=1286‑1291). | Поток событий восстановлен, нагрузка стабилизирована. |
| 2026‑02‑02 | Запуск процесса синхронизации системных часов ДК. | Требования Яндекса к точному времени (msg_id=1297‑1303). | Планируется автоматизация, ожидается уменьшение drift. |
| 2026‑02‑03 | Возобновление подписки на **все** светофоры. | Требуется полное покрытие для тестов (msg_id=1304‑1308). | Увеличена нагрузка, наблюдается рост трафика (msg_id=1309‑1310). |

---

## 2. Контроллеры и конфигурации  

### 2.1. Список контроллеров  

| tlc_id | Тип | Версия ПО | Конфигурация | Параметры | Источник | Статус | Примечания |
|--------|-----|-----------|--------------|-----------|----------|--------|------------|
| 2969 | Spectr2 | 3.17 | `config.json` | Направления **1п**, **5п** (msg_id=806) | msg_id=806 | OK | 1п ↔ 13, 5п ↔ 14 |
| 2369 | Spectr2 | 3.17 | – | – | msg_id=807 | OK | – |
| 1315 | Spectr2 | 3.17 | – | Fixed‑программа, таймеры до конца желтого (msg_id=973‑974) | msg_id=973‑974 | OK | Иногда неверные сочетания (зелёный+желтый) |
| 1316 | Spectr2 | 3.17 | – | Fixed, без таймеров (msg_id=1005) | msg_id=1005 | OK | Управляемое табло |
| 2338 | Spectr2 | 3.17 | – | StageRing, 2‑фазный (msg_id=896) | msg_id=896 | OK | Пример программы (msg_id=896) |
| 3219 | Spectr2 | 3.17 | – | StageRing, расписание фиксировано (msg_id=895) | msg_id=895 | OK | Всегда StageRing |
| 1339 | Spectr2 | 3.17 | – | Fixed днём, StageRing ночью (msg_id=897‑898) | msg_id=897‑898 | OK | Переключение по времени |
| 315 | Spectr2 | 3.18 | – | Проблемы длительностей фаз, мигающий зелёный (msg_id=1251‑1252) | msg_id=1251‑1252 | Ошибка | Задержки 5‑20 сек, нестабильные сигналы |
| 50076 | RUKON | 2.5 | – | Только фазы, SG не передаются (msg_id=1174‑1176) | msg_id=1174‑1176 | Проблема | SG недоступны, OCIT |
| 306, 1520‑1523‑1526‑1535 | UK GEAR | 1.9 | – | Частично SG, частично только фазы (msg_id=1224‑1229) | msg_id=1224‑1229 | Частично OK | Зависит от прошивки |
| 2553, 2718, 6114, 6121 | UK GEAR | 1.9 | – | SG не передаются, только фазы (msg_id=1214‑1222) | msg_id=1214‑1222 | Проблема | Требуется отдельный парсинг |
| **Всего** | – | – | – | **1742** узла в системе (msg_id=834) | – | – | Полный перечень в OCR `msg_id=252`. |

> **Примечание:** Таблица будет дополнена в следующем релизе полной детализацией всех 1742 узлов.

### 2.2. Детальные конфигурации  

| Тип контроллера | Ключевые поля конфигурации | Пример (msg_id) |
|-----------------|----------------------------|-----------------|
| Spectr2 | `SignalGroup` (id, name, connections), `connections` (IDs of `Connection`), `Connection` (id, lane_from, lane_to) | `{"id":-156268,"name":"1","connections":"-39437 -39436 -50198 -39435 -50165"}` (msg_id=831) |
| CrossAdapter | `SignalGroup` отсутствует, только `Stage` и `Phase` в `DynamicProgram` | `{"type":"StageRing","sequence":[1,2],"cycle":110,"phases":[{"id":1,"stage":1,"recall":"max","minGreen":74,"maxGreen":7}]}` (msg_id=896) |
| UK GEAR | `SignalGroup` присутствует, но только для новых прошивок | `{"id":-156268,"name":"1","connections":"-39437 -39436 -50198 -39435 -50165"}` (msg_id=831) |
| RUKON | `SignalGroup` отсутствует, только `Stage` и `Phase` | `{"type":"StageRing","sequence":[1,2],"cycle":110,"phases":[{"id":1,"stage":1,"recall":"max","minGreen":74,"maxGreen":7}]}` (msg_id=896) |

> **OCR‑подтверждение:**  
> *msg_id=186* – описание API‑эндпоинтов (`/tlc/get_dynamic_program`, `/tlc/get_last_configuration`, `/tlc/event_stream`).  
> *msg_id=234* – список доступных эндпоинтов и их методы.  
> *msg_id=252* – список всех контроллеров и их типы (Spectr, Spectr2, CrossAdapter, UK GEAR, RUKON).  

### 2.3. Изменения конфигураций  

| Дата | Контроллер | Изменение | Причина | Результат |
|------|------------|-----------|---------|-----------|
| 2025‑12‑08 | 2969 | Добавлены новые направления (1п → 13, 5п → 14) | Переработка схемы (msg_id=806) | Согласовано с Яндексом (msg_id=816). |
| 2025‑12‑12 | 1315 | Перенастройка таймеров Fixed (зеленый до конца желтого) | Ошибка в конфигурации (msg_id=973‑974) | Стабильность сигналов улучшена (msg_id=973‑974). |
| 2025‑12‑19 | 2338 | Добавлена поддержка StageRing с offset 100 с | Требования Яндекса (msg_id=896) | Успешно интегрировано (msg_id=896). |
| 2025‑12‑24 | 315 | Исправлена некорректная интерпретация желтого (не включается в таймер) | Ошибка в логике таймеров (msg_id=973‑974) | Таймеры теперь корректны (msg_id=973‑974). |
| 2026‑01‑14 | 50076 | Добавлена поддержка SG через новый эндпоинт `cnf_storage` | Требования Яндекса (msg_id=1174‑1176) | SG теперь доступны (msg_id=1174‑1176). |
| 2026‑01‑27 | 306, 1520‑1523‑1526‑1535 | Обновлена прошивка до версии 1.9, включена поддержка SG | Проблемы с SG (msg_id=1224‑1229) | SG теперь доступны (msg_id=1224‑1229). |
| 2026‑02‑02 | 2338 | Синхронизация времени по NTP | Расхождения времени (msg_id=1053‑1055) | Drift уменьшен до < 0.5 с (msg_id=1084‑1092). |

---

## 3. Фазы и направления  

### 3.1. Описание фаз для каждого контроллера  

| tlc_id | Фаза | Длительность (с) | Тип | Примечание |
|--------|------|-------------------|-----|------------|
| 2338 | 1 | 8 + 13 = 21 | StageRing | 2‑фазный, offset 100 с (msg_id=896) |
| 2338 | 2 | 8 + 13 = 21 | StageRing | 2‑фазный, offset 100 с (msg_id=896) |
| 3219 | 1 | 110 | StageRing | Фиксированное расписание (msg_id=895) |
| 1339 | 1 | 110 | Fixed | Днём (msg_id=897‑898) |
| 1339 | 2 | 110 | StageRing | Ночью (msg_id=897‑898) |
| 315 | 1 | 110 | StageRing | Проблемы с таймингом (msg_id=1251‑1252) |
| 50076 | 1 | 110 | StageRing | Только фазы, SG отсутствуют (msg_id=1174‑1176) |
| 306 | 1 | 110 | StageRing | SG отсутствуют, только фазы (msg_id=1214‑1222) |

> **OCR‑подтверждение:**  
> *msg_id=123* – схема фаз для 3219 (показана в OCR).  
> *msg_id=186* – описание API‑эндпоинтов, включая `get_dynamic_program`.  

### 3.2. Схемы направлений  

| tlc_id | Направление | ID | Тип | Примечание |
|--------|-------------|----|-----|------------|
| 2969 | 1п | 13 | Fixed | Согласовано с Яндексом (msg_id=816) |
| 2969 | 5п | 14 | Fixed | Согласовано с Яндексом (msg_id=816) |
| 2338 | 12 | 12 | StageRing | Пример SG (msg_id=823) |
| 2338 | 13 | 13 | StageRing | Пример SG (msg_id=823) |
| 315 | 2 | 2 | StageRing | Проблемы с таймингом (msg_id=1251‑1252) |

### 3.3. Выявленные несоответствия  

| ID | Описание | Причина | Решение | Статус |
|----|----------|---------|---------|--------|
| 1315 | Таймеры Fixed включают желтый в зелёный | Ошибка в конфигурации (msg_id=973‑974) | Перенастройка таймеров (msg_id=973‑974) | Закрыто |
| 315 | Нестабильные таймеры, задержки 5‑20 с | Проблема с прошивкой (msg_id=1251‑1252) | Обновление прошивки, проверка логики таймеров | Открыто |
| 50076 | SG не передаются | Протокол OCIT (msg_id=1174‑1176) | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |
| 306 | SG отсутствуют | Старый тип прошивки (msg_id=1214‑1222) | Обновление прошивки до 1.9 (msg_id=1224‑1229) | Закрыто |

### 3.4. Подтверждённые схемы  

| tlc_id | Фаза | Длительность (с) | Тип | Подтверждённый источник |
|--------|------|-------------------|-----|--------------------------|
| 2338 | 1 | 21 | StageRing | msg_id=896 |
| 2338 | 2 | 21 | StageRing | msg_id=896 |
| 3219 | 1 | 110 | StageRing | msg_id=895 |
| 1339 | 1 | 110 | Fixed | msg_id=897‑898 |
| 1339 | 2 | 110 | StageRing | msg_id=897‑898 |
| 2969 | 1п | 13 | Fixed | msg_id=816 |
| 2969 | 5п | 14 | Fixed | msg_id=816 |

---

## 4. Временные параметры  

### 4.1. Циклы светофоров  

| tlc_id | Цикл (с) | Фаза | Тип | Примечание |
|--------|----------|------|-----|------------|
| 2338 | 110 | 1 | StageRing | offset 100 с (msg_id=896) |
| 2338 | 110 | 2 | StageRing | offset 100 с (msg_id=896) |
| 3219 | 110 | 1 | StageRing | Фиксированное расписание (msg_id=895) |
| 1339 | 110 | 1 | Fixed | Днём (msg_id=897‑898) |
| 1339 | 110 | 2 | StageRing | Ночью (msg_id=897‑898) |
| 315 | 110 | 1 | StageRing | Проблемы с таймингом (msg_id=1251‑1252) |

### 4.2. Оффсеты и координация  

| tlc_id | Offset (с) | Координация | Примечание |
|--------|------------|-------------|------------|
| 2338 | 100 | Coordinated | StageRing (msg_id=896) |
| 2338 | 100 | Coordinated | StageRing (msg_id=896) |
| 3219 | 0 | Coordinated | Фиксированное расписание (msg_id=895) |
| 1339 | 0 | Coordinated | Fixed (msg_id=897‑898) |
| 1339 | 0 | Coordinated | StageRing (msg_id=897‑898) |

### 4.3. Проблемы синхронизации  

| tlc_id | Расхождение (с) | Причина | Решение | Статус |
|--------|-----------------|---------|---------|--------|
| 2338 | 14 | NTP drift | Синхронизация по NTP (msg_id=1084‑1092) | Закрыто |
| 2338 | 7 | Периодические задержки | Оптимизация SSE‑потока (msg_id=822) | Открыто |
| 315 | 5‑20 | Проблема прошивки | Обновление прошивки, проверка логики таймеров | Открыто |
| 50076 | 0 | SG отсутствуют | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |

### 4.4. Временные диаграммы  

| tlc_id | Диаграмма | Примечание |
|--------|-----------|------------|
| 2338 | 1‑2‑1‑2 (21 с) | StageRing (msg_id=896) |
| 1339 | 1‑2‑1‑2 (110 с) | Fixed днём, StageRing ночью (msg_id=897‑898) |
| 315 | 1‑2‑1‑2 (110 с) | Проблемы с таймингом (msg_id=1251‑1252) |

> **OCR‑подтверждение:**  
> *msg_id=113* – матрица переходов (intergreen matrix).  
> *msg_id=123* – схема фаз для 3219.  

---

## 5. Обнаруженные проблемы и их решения  

### 5.1. Критические проблемы  

| ID | Описание | Контекст | Причина | Последствия | Решение | Статус | Следующий шаг | Источник (msg_id) |
|----|----------|----------|---------|-------------|---------|--------|---------------|-------------------|
| 1 | 403 при доступе к `cnf_storage` | CrossAdapter | Ограничения доступа (msg_id=1156) | Невозможность получить конфигурацию | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто | Проверка доступа | 1156 |
| 2 | 504 при авторизации | ДОДД | Проблемы с токеном (msg_id=1286‑1291) | Потеря SSE‑потока | Перезапуск серверов, обновление токенов (msg_id=1288) | Закрыто | Мониторинг | 1286‑1291 |
| 3 | Нестабильные таймеры StageRing | 315 | Проблема прошивки (msg_id=1251‑1252) | Неправильные таймеры, задержки 5‑20 с | Обновление прошивки, проверка логики таймеров | Открыто | Тестирование | 1251‑1252 |
| 4 | SG не передаются RUKON | 50076 | Протокол OCIT (msg_id=1174‑1176) | Невозможность получить SG | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто | Проверка | 1174‑1176 |
| 5 | Периодические потери SSE‑потока | 2338 | Сетевые задержки (msg_id=822) | Потеря сигналов, задержки 5‑10 с | Оптимизация SSE‑потока, мониторинг (msg_id=822) | Открыто | Тестирование | 822 |

### 5.2. Технические проблемы  

| ID | Описание | Причина | Решение | Статус |
|----|----------|---------|---------|--------|
| 6 | 403 при `get_last_configuration` для CrossAdapter | Ограничения доступа (msg_id=1156) | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |
| 7 | 403 при `status` для RUKON | Ограничения доступа (msg_id=1156) | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |
| 8 | Неправильный интерпретатор желтого в Fixed | Ошибка в конфигурации (msg_id=973‑974) | Перенастройка таймеров (msg_id=973‑974) | Закрыто |
| 9 | Неправильный offset StageRing | Ошибка в конфигурации (msg_id=896) | Перенастройка offset (msg_id=896) | Закрыто |

### 5.3. Проблемы интеграции  

| ID | Описание | Причина | Решение | Статус |
|----|----------|---------|---------|--------|
| 10 | 403 при доступе к `tlc/cnf_storage` | Ограничения доступа (msg_id=1156) | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |
| 11 | 403 при `get_dynamic_program` для некоторых контроллеров | Ограничения доступа (msg_id=1156) | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Закрыто |
| 12 | 504 при авторизации | Проблемы с токеном (msg_id=1286‑1291) | Перезапуск серверов, обновление токенов (msg_id=1288) | Закрыто |

### 5.4. История решений проблем  

| Дата | Проблема | Решение | Комментарий |
|------|----------|---------|-------------|
| 2025‑12‑12 | 403 при `cnf_storage` | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Решено (msg_id=1156). |
| 2025‑12‑19 | 403 при `get_last_configuration` | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Решено (msg_id=1156). |
| 2025‑12‑24 | Неправильный интерпретатор желтого | Перенастройка таймеров (msg_id=973‑974) | Решено (msg_id=973‑974). |
| 2026‑01‑14 | 504 при авторизации | Перезапуск серверов, обновление токенов (msg_id=1288) | Решено (msg_id=1286‑1291). |
| 2026‑01‑27 | SG не передаются RUKON | Добавлен эндпоинт `cnf_storage` (msg_id=1174‑1176) | Решено (msg_id=1174‑1176). |
| 2026‑01‑30 | Нестабильные таймеры StageRing | Обновление прошивки, проверка логики таймеров | Открыто (msg_id=1251‑1252). |

---

## 6. Технические решения и обоснования  

### 6.1. Принятые архитектурные решения  

| Решение | Обоснование | Влияние |
|---------|-------------|---------|
| Переход на статическую Swagger‑спецификацию | Уменьшение нагрузки на сервер, повышение безопасности (msg_id=842‑844) | 403 для некоторых эндпоинтов, но стабильность API |
| Добавление эндпоинта `cnf_storage` | Необходимость получения конфигураций для CrossAdapter и RUKON (msg_id=1174‑1176) | Расширение доступа к конфигурациям |
| Синхронизация времени по NTP | Уменьшение drift до < 0.5 с (msg_id=1084‑1092) | Улучшение точности таймеров |
| Ограничение подписки на 267 светофоров | Снижение нагрузки на 6× (msg_id=1108) | Стабильность SSE‑потока |
| Перезапуск серверов граберов | Решение 504 при авторизации (msg_id=1286‑1291) | Восстановление SSE‑потока |

### 6.2. Выбранные технологии и инструменты  

| Технология | Инструмент | Роль | Примечание |
|------------|------------|------|------------|
| REST | `tlc` API | Обмен данными | Используется Яндексом (msg_id=803). |
| SSE | `/tlc/event_stream` | Поток событий | Публикуется ДК (msg_id=822). |
| PostgreSQL | Хранилище | События, конфигурации | Таблицы `tlc_config`, `tlc_events`. |
| Grafana + Prometheus | Мониторинг | Метрики, алерты | Публикуются через `/metrics` (msg_id=1288). |
| NTP | Синхронизация времени | Точное время | Используется ДК (msg_id=1053‑1055). |
| Docker | Контейнеризация | Развертывание | Используется для `tlc` API и граберов. |

### 6.3. Альтернативные решения и их анализ  

| Альтернатива | Описание | Плюсы | Минусы | Выбор |
|--------------|----------|-------|--------|-------|
| Использовать WebSocket вместо SSE | Более гибкая коммуникация | Быстрее, меньше задержек | Требует дополнительной реализации | Не выбрано |
| Перенести конфигурацию в Kafka | Масштабируемость | Высокая доступность | Сложность, дополнительные затраты | Не выбрано |
| Переход на OAuth2 вместо Bearer‑токен | Улучшенная безопасность | Стандартный протокол | Сложность интеграции | Не выбрано |
| Использовать gRPC | Быстрее, типизированные сообщения | Быстрее, меньше трафика | Требует изменения API | Не выбрано |

---

## 7. Гипотезы и вопросы  

### 7.1. Неподтверждённые гипотезы  

| Гипотеза | Обоснование | План проверки | Статус |
|----------|-------------|---------------|--------|
| 1. Периодические потери SSE‑потока вызваны сетевыми задержками | Наблюдаются задержки 5‑10 с (msg_id=822) | Тестирование сети, измерение RTT (msg_id=1324) | Открыто |
| 2. Нестабильные таймеры StageRing связаны с прошивкой | Проблема наблюдается только на 315 (msg_id=1251‑1252) | Обновление прошивки, сравнение логов | Открыто |
| 3. SG отсутствуют у RUKON из-за протокола OCIT | 403 при `cnf_storage` (msg_id=1174‑1176) | Проверка протокола, обновление прошивки | Открыто |

### 7.2. Открытые вопросы  

| Вопрос | Контекст | Важность | План решения |
|--------|----------|----------|--------------|
| Как быстро синхронизировать часы ДК? | Drift до 10 с (msg_id=1053‑1055) | Высокая | Автоматизация NTP‑синхронизации (msg_id=1084‑1092). |
| Как обеспечить доступ к `cnf_storage` для всех контроллеров? | 403 для CrossAdapter (msg_id=1156) | Средняя | Добавить эндпоинт `cnf_storage` (msg_id=1174‑1176). |
| Как уменьшить задержки SSE‑потока? | Задержки 5‑10 с (msg_id=822) | Средняя | Оптимизация SSE‑потока, мониторинг RTT (msg_id=1324). |
| Как обрабатывать `server_stop` в потоке сигналов? | `server_stop` появляется (msg_id=1315) | Средняя | Игнорировать, но логировать (msg_id=131