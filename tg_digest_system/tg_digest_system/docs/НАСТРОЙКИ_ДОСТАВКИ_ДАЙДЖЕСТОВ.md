# Настройки доставки дайджестов по чатам

Настройки отправки дайджестов вынесены в отдельный файл **`config/digest_delivery.json`**. По каждому подконтрольному чату можно задать:

- **Важный чат** (`importance: "important"`) — полный дайджест: текст в сообщении + файл.
- **Ознакомительный чат** (`importance: "informational"`) — краткое сообщение (например, первые 500 символов), без файла или с ограничением длины.

Файл не обязателен: если его нет, для всех каналов используется полная доставка (как раньше).

---

## Расположение файла

- По умолчанию: **рядом с `channels.json`** — то есть `config/digest_delivery.json` (при `CONFIG_FILE=/app/config/channels.json` путь к настройкам доставки: `/app/config/digest_delivery.json`).
- Переопределение: переменная окружения **`DIGEST_DELIVERY_FILE`** — полный путь к файлу.

При деплое каталог **`config/`** монтируется в контейнер воркера (`../config:/app/config`), поэтому достаточно положить `digest_delivery.json` в `config/` в репозитории (или на ВМ рядом с `channels.json`).

---

## Формат `digest_delivery.json`

```json
{
  "defaults": {
    "importance": "important",
    "send_file": true,
    "send_text": true,
    "text_max_chars": null,
    "summary_only": false
  },
  "channels": {
    "-1002700886173": {
      "importance": "important",
      "send_file": true,
      "send_text": true
    },
    "-1001234567890": {
      "importance": "informational",
      "send_file": false,
      "send_text": true,
      "text_max_chars": 500,
      "summary_only": true
    }
  }
}
```

- **defaults** — значения по умолчанию для чатов, не перечисленных в `channels`.
- **channels** — объект: ключ = **Telegram ID чата** (строка, например `-1002700886173`), значение — настройки.

Поля для каждого чата (и в `defaults`):

| Поле | Тип | Описание |
|------|-----|----------|
| **importance** | `"important"` \| `"informational"` | Важный (полный дайджест) или ознакомительный. |
| **send_file** | boolean | Отправлять ли файл с полным дайджестом. Для ознакомительных обычно `false`. |
| **send_text** | boolean | Отправлять ли текст дайджеста в сообщении. |
| **text_max_chars** | number или null | Ограничение длины текста в сообщении (для ознакомительных, например 500). |
| **summary_only** | boolean | Если `true`, в сообщение идёт только заголовок + обрезанный по `text_max_chars` текст (без полного блока изменений в сводном документе в том же сообщении). |

Итоговые флаги доставки для получателя: **настройки по чату** (из этого файла) **и** настройки получателя в канале (например, из веб-интерфейса или `channels.json`). Отправка текста/файла выполняется только если разрешено и там, и там.

---

## Примеры

1. **Все чаты по умолчанию важные** — файл можно не создавать или оставить только `defaults` с `importance: "important"`.
2. **Один чат ознакомительный, остальные важные** — в `channels` указать только этот чат с `importance: "informational"`, `send_file: false`, `text_max_chars: 500`, `summary_only: true`.
3. **Разные лимиты по чатам** — задать в `channels` для каждого чата свои `text_max_chars` и `send_file`.

Схема для проверки/подсказок: **`config/digest_delivery.schema.json`**.

---

## Настройки доставки в веб-интерфейсе

Для каналов, добавленных через веб (**Мои каналы**), настройки доставки хранятся в БД (таблица `web_channels`, миграция 008) и редактируются в интерфейсе:

- На странице **Мои каналы** в таблице отображается колонка **Доставка**: «Важный» или «Ознакомительный».
- В модальном окне **Редактировать канал** есть блок **Доставка дайджеста**:
  - **Важность чата** — «Важный» (полный дайджест: текст + файл) или «Ознакомительный» (кратко, без файла).
  - Чекбоксы **Отправлять текст**, **Отправлять файл**, **Только краткое резюме**.
  - **Макс. символов в сообщении** — для ознакомительных (например, 500).

Воркер для каналов из веба берёт настройки из БД; для каналов из файла `channels.json` — из `config/digest_delivery.json`.
