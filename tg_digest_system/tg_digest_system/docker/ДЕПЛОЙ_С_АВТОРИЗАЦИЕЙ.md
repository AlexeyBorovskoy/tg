# Деплой с включённой авторизацией (весь сервис закрыт идентификацией)

## Быстрый старт для 93.77.185.71

1. **На ВМ перейдите в каталог docker:**
   ```bash
   cd /path/to/tg_digest_system/tg_digest_system/docker
   ```

2. **Создайте/обновите `secrets.env`** (скопируйте из `secrets.env.example` если нет):
   ```bash
   cp secrets.env.example secrets.env
   nano secrets.env
   ```

3. **Заполните обязательные параметры авторизации:**
   ```bash
   AUTH_OWN_ENABLED=1
   BASE_URL=http://93.77.185.71:8000
   JWT_SECRET=<длинная_случайная_строка_минимум_32_символа>
   YANDEX_OAUTH_CLIENT_ID=<ваш_client_id>
   YANDEX_OAUTH_CLIENT_SECRET=<ваш_client_secret>
   ```

   **Как получить Yandex OAuth:**
   - Зайдите на https://oauth.yandex.ru
   - Создайте приложение
   - Callback URI: `http://93.77.185.71:8000/auth/yandex/callback`
   - Скопируйте ID и пароль в `secrets.env`

4. **Заполните остальные секреты** (если ещё не заполнены):
   - `PGPASSWORD` — пароль PostgreSQL
   - `TG_API_ID`, `TG_API_HASH` — из https://my.telegram.org
   - `OPENAI_API_KEY` — ключ OpenAI
   - `TG_BOT_TOKEN` — токен бота (опционально)

5. **Примените миграции** (если БД уже существует и нужно добавить таблицы для авторизации):
   ```bash
   docker compose run --rm migrate
   ```
   Или если используете существующую БД на хосте:
   ```bash
   docker compose -f docker-compose.yml -f docker-compose.existing.yml run --rm migrate
   ```

6. **Запустите/перезапустите сервисы:**
   ```bash
   docker compose up -d --force-recreate web
   ```

7. **Проверьте логи:**
   ```bash
   docker compose logs -f web
   ```
   Убедитесь, что нет ошибок подключения к БД и что OAuth настройки загружены.

8. **Откройте в браузере:**
   - http://93.77.185.71:8000/
   - Должен произойти редирект на `/login`
   - Нажмите «Войти через Яндекс»
   - После входа откроется главная страница

## Что закрыто авторизацией

При `AUTH_OWN_ENABLED=1` **весь сервис закрыт идентификацией**:

- ✅ **Требуют входа:** `/`, `/channels`, `/prompts`, `/users`, `/instructions`, все `/api/*`
- ✅ **Доступны без входа:** `/login`, `/auth/yandex`, `/auth/yandex/callback`, `/logout`, `/health`

Middleware автоматически перенаправляет неавторизованных пользователей на `/login?next=...`.

## Отключение авторизации (не рекомендуется)

Если нужно временно отключить авторизацию (например, для тестирования):

```bash
# В secrets.env:
AUTH_OWN_ENABLED=0

# Перезапустите:
docker compose up -d --force-recreate web
```

**Внимание:** без авторизации весь сервис доступен всем, кто знает URL. Используйте только для разработки или в защищённой сети.

## Проверка работы авторизации

1. Откройте http://93.77.185.71:8000/ в режиме инкогнито (без cookies)
2. Должен произойти редирект на `/login`
3. После входа через Яндекс вы должны попасть на главную
4. Cookie `auth_token` должен быть установлен (проверьте в DevTools → Application → Cookies)

## Устранение проблем

**Проблема:** Редирект на `/login` не происходит, страница открывается без входа  
**Решение:** Проверьте, что в `secrets.env` задано `AUTH_OWN_ENABLED=1` и перезапустите web:
```bash
docker compose up -d --force-recreate web
```

**Проблема:** «Ошибка входа через Yandex»  
**Решение:** 
- Проверьте, что `BASE_URL` в `secrets.env` точно совпадает с адресом в браузере (без слэша в конце)
- Проверьте, что Callback URI в кабинете OAuth Яндекс совпадает с `BASE_URL/auth/yandex/callback`
- Перезапустите web после изменений

**Проблема:** Кнопка «Войти через Яндекс» не видна  
**Решение:** Проверьте, что в `secrets.env` заданы `YANDEX_OAUTH_CLIENT_ID` и `YANDEX_OAUTH_CLIENT_SECRET`
