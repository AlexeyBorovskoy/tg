# Настройка туннеля для доступа к OpenAI API

## Проблема
OpenAI API блокирует запросы из некоторых регионов (включая РФ). Для обхода блокировки используется SOCKS5 туннель через SSH или VPN.

## Вариант 1: SSH туннель (рекомендуется)

### Шаг 1: Создать SSH туннель на сервере

Если у вас есть доступ к VPS серверу с выходом в интернет (не из РФ), создайте SSH туннель:

```bash
# На сервере Yandex Cloud (93.77.185.71)
# Создать SSH туннель к вашему VPS серверу
ssh -D 1080 -f -N user@your-vps-server.com

# Проверить, что туннель работает
ss -tlnp | grep 1080
# Должно показать: LISTEN 0 128 127.0.0.1:1080
```

**Важно:** Замените `user@your-vps-server.com` на реальные данные вашего VPS сервера.

### Шаг 2: Настроить прокси в secrets.env

Добавьте в `/home/yc-user/tg_digest_system/tg_digest_system/docker/secrets.env`:

```bash
# Прокси для OpenAI через локальный SOCKS5 туннель
HTTPS_PROXY=socks5://127.0.0.1:1080
HTTP_PROXY=socks5://127.0.0.1:1080
```

### Шаг 3: Перезапустить worker

```bash
cd /home/yc-user/tg_digest_system/tg_digest_system/docker
docker compose restart worker
```

### Шаг 4: Проверить работу

```bash
# Проверить логи worker на наличие ошибок OpenAI
docker compose logs worker --tail 50 | grep -E '(OpenAI|403|PermissionDenied)'

# Должно быть сообщение: "OpenAI клиент настроен с прокси: socks5://127.0.0.1:1080"
```

## Вариант 2: Внешний SOCKS5 прокси

Если у вас есть внешний SOCKS5 прокси сервер:

```bash
# В secrets.env
HTTPS_PROXY=socks5://proxy.example.com:1080
HTTP_PROXY=socks5://proxy.example.com:1080
```

## Вариант 3: HTTP прокси

Если у вас есть HTTP прокси:

```bash
# В secrets.env
HTTPS_PROXY=http://proxy.example.com:8080
HTTP_PROXY=http://proxy.example.com:8080
```

## Вариант 4: VPN клиент (Amnezia VPN)

В старом проекте использовался Amnezia VPN. Если у вас есть конфигурация VPN:

1. Установите VPN клиент на сервере
2. Настройте локальный SOCKS5 прокси на порту 1080
3. Используйте `HTTPS_PROXY=socks5://127.0.0.1:1080` в secrets.env

## Автозапуск SSH туннеля (systemd)

Чтобы туннель запускался автоматически при перезагрузке сервера:

```bash
# Создать systemd сервис для SSH туннеля
sudo nano /etc/systemd/system/ssh-tunnel-openai.service
```

Содержимое файла:

```ini
[Unit]
Description=SSH Tunnel for OpenAI API
After=network.target

[Service]
Type=simple
User=yc-user
ExecStart=/usr/bin/ssh -D 1080 -f -N -o ServerAliveInterval=60 -o ServerAliveCountMax=3 user@your-vps-server.com
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Затем:

```bash
# Включить автозапуск
sudo systemctl enable ssh-tunnel-openai.service
sudo systemctl start ssh-tunnel-openai.service

# Проверить статус
sudo systemctl status ssh-tunnel-openai.service
```

## Проверка работы туннеля

```bash
# Проверить, что порт 1080 слушается
ss -tlnp | grep 1080

# Проверить доступность OpenAI через туннель (из контейнера worker)
docker compose exec worker curl -x socks5://127.0.0.1:1080 https://api.openai.com/v1/models -H "Authorization: Bearer $OPENAI_API_KEY" | head -20
```

## Устранение проблем

### Туннель не работает
- Проверьте SSH доступ к VPS серверу: `ssh user@your-vps-server.com`
- Проверьте, что порт 1080 не занят: `ss -tlnp | grep 1080`
- Проверьте логи SSH туннеля: `journalctl -u ssh-tunnel-openai -n 50`

### Worker не использует прокси
- Проверьте переменные окружения в контейнере: `docker compose exec worker env | grep PROXY`
- Проверьте логи worker: `docker compose logs worker | grep -i proxy`
- Убедитесь, что `HTTPS_PROXY` указан в `secrets.env` и загружается через `env_file` в docker-compose.yml

### Ошибка 403 от OpenAI
- Убедитесь, что туннель действительно работает и трафик идет через него
- Проверьте, что VPS сервер находится в регионе, где OpenAI доступен
- Проверьте, что API ключ валидный: `docker compose exec worker python -c "import os; print('Key:', os.environ.get('OPENAI_API_KEY', 'NOT SET')[:20])"`
