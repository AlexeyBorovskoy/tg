# Пошаговая инструкция: деплой TG Digest в Yandex Cloud

Подробное описание каждого шага. Выполняйте команды **на своём компьютере** в терминале, если не указано иное.

---

## Часть 1. Установка и настройка Yandex Cloud CLI (yc)

### Шаг 1.1. Открыть терминал

- **Linux (Mint/Ubuntu):** `Ctrl+Alt+T` или меню «Терминал».
- Убедитесь, что вы в своей обычной оболочке (bash).

**Что делаем:** все следующие команды вводятся в этом терминале.

---

### Шаг 1.2. Перейти в папку проекта (опционально, для удобства)

```bash
cd /home/alexey/work/hgfs_mirror/shared/analysis-methodology/tg_digest_system/tg_digest_system/docker/yandex
```

**Что делаем:** переходим в каталог, где лежит скрипт деплоя. Можно выполнять команды и из домашней папки — пути в инструкции будут указаны явно.

**Проверка:** выполните `ls` — в списке должны быть файлы `deploy-yandex-full.sh`, `README.md`, `setup-on-vm.sh`.

---

### Шаг 1.3. Установить Yandex Cloud CLI (yc)

Выполните **одну** из двух команд.

**Вариант А — установка в домашний каталог (рекомендуется):**

```bash
curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i $HOME/.local/yc -a
```

**Что происходит:** скрипт скачивается, устанавливает бинарник `yc` в `~/.local/yc/bin/` и **сам** добавляет эту папку в `PATH` в файл `~/.bashrc`. Флаг `-a` как раз даёт «добавить в PATH и completion».

**Вариант Б — установка во временную папку (без правки .bashrc):**

```bash
curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i /tmp/yc-install -n
```

**Что происходит:** `yc` ставится в `/tmp/yc-install/bin/`. В текущем терминале PATH не изменится — его нужно будет задать вручную (шаг 1.4 для варианта Б).

**Проверка:** после варианта А откройте **новый** терминал или выполните `source ~/.bashrc`, затем введите:

```bash
yc --version
```

Должна появиться строка вида `Yandex Cloud CLI 0.191.0 ...`. Если использовали вариант Б, сначала выполните (в том же терминале):

```bash
export PATH=/tmp/yc-install/bin:$PATH
yc --version
```

---

### Шаг 1.4. Инициализация профиля yc (yc init) — куда вводить и как получать

В терминале выполните:

```bash
yc init
```

Ниже — **по шагам: куда вводить, что копировать и откуда брать**.

---

#### Шаг A: Вход в аккаунт (токен)

**В терминале** после запуска `yc init` появится что-то вроде:

```text
Please go to https://oauth.yandex.ru/authorize?response_type=token&client_id=...
```

**Что делать:**

1. **Скопировать ссылку** из терминала целиком (от `https://` до конца строки). Можно выделить мышкой и Ctrl+Shift+C, или скопировать вручную.
2. **Вставить ссылку в браузер** (адресная строка) и нажать Enter.
3. **В браузере:** войти в свой аккаунт Yandex (логин/пароль), если ещё не вошли. Подтвердить доступ приложению (кнопка «Разрешить» или аналогичная).
4. **На странице после входа** появится **токен** — длинная строка букв и цифр (иногда показана как «Пароль для приложения» или просто «Токен»). **Скопируйте этот токен** (целиком).
5. **Вернитесь в терминал.** Программа спросит что-то вроде «Please enter OAuth token» или «Введите токен». **Вставьте скопированный токен** в терминал (правый клик → Вставить, или Ctrl+Shift+V) и нажмите **Enter**.

**Важно:** токен в терминал **не отображается** при вводе (из соображений безопасности) — просто вставьте и нажмите Enter.

---

#### Шаг B: Выбор облака (cloud)

В терминале появится список облаков, например:

```text
[1] cloud-1 (id = b1gxxxxxxxxxx) ...
[2] default (id = b1gxxxxxxxxxx) ...
Please enter your choice:
```

**Куда вводить:** в ту же строку в терминале, где мигает курсор после `Please enter your choice:` (или «Введите номер»).

**Что вводить:** номер из списка — одну цифру, например `1` или `2`, затем **Enter**.  
Если облако одно — обычно вводят `1`. Это то же облако, в котором вы заходите в консоль https://console.cloud.yandex.ru.

---

#### Шаг C: Выбор каталога (folder)

Появится список каталогов, например:

```text
[1] default (id = b1gxxxxxxxxxx)
[2] my-folder (id = b1gxxxxxxxxxx)
Please enter your choice:
```

**Куда вводить:** в терминал, в строку с приглашением выбора.

**Что вводить:** номер каталога, в котором хотите создать ВМ — например `1` или `2`, затем **Enter**.  
Узнать свой каталог можно в веб-консоли Yandex Cloud: вверху страницы (под логотипом) выпадающий список — там название каталога. Выберите в `yc init` тот же по имени или по номеру в списке.

---

#### Шаг D: Зона доступности (zone)

Может спросить зону по умолчанию, например:

```text
[1] ru-central1-a
[2] ru-central1-b
[3] ru-central1-d
Please enter your choice [1]:
```

**Куда вводить:** в терминал.

**Что вводить:** можно просто нажать **Enter** — тогда выберется вариант по умолчанию (часто `ru-central1-a`, указан в квадратных скобках `[1]`). Или ввести `1` и Enter. Этого достаточно для деплоя.

---

#### Шаг E: Служебный каталог (если спросят)

Иногда спрашивают: «Do you want to create a default compute zone?» или про создание каталога для метаданных.

**Куда вводить:** в терминал.

**Что вводить:** можно ответить `n` (no) и Enter, или `y` (yes) и Enter — на работу деплоя это не влияет.

---

После этого `yc init` завершится и вы снова увидите приглашение оболочки (`$` или `user@host:~$`). Значит, профиль сохранён.

**Проверка:** после успешного завершения выполните:

```bash
yc config list
```

Должны быть заполнены строки `token`, `cloud-id`, `folder-id`. Если всё так — переходите к части 2.

---

## Часть 2. Запуск деплоя

### Шаг 2.1. Перейти в каталог со скриптом деплоя

```bash
cd /home/alexey/work/hgfs_mirror/shared/analysis-methodology/tg_digest_system/tg_digest_system/docker/yandex
```

**Что делаем:** скрипт `deploy-yandex-full.sh` должен запускаться из этой папки (он обращается к путям относительно себя).

---

### Шаг 2.2. Дать скрипту право на выполнение (если ещё не дано)

```bash
chmod +x deploy-yandex-full.sh
```

**Что делаем:** без этого при запуске `./deploy-yandex-full.sh` будет ошибка «Отказано в доступе». Достаточно выполнить один раз.

---

### Шаг 2.3. Запустить полный деплой

```bash
./deploy-yandex-full.sh
```

**Что делает скрипт по шагам:**

1. Проверяет, что `yc` установлен и настроен (`yc config list`).
2. Создаёт в Yandex Cloud сеть `net-tg-digest` и подсеть `subnet-tg-digest` (если их ещё нет).
3. Создаёт ВМ с именем **tg-digest** (Ubuntu 22.04, 2 vCPU, 4 ГБ RAM, 20 ГБ диск, с публичным IP).
4. Ждёт, пока у ВМ появится публичный IP и станет доступен SSH.
5. Устанавливает на ВМ Docker (если ещё не установлен).
6. Копирует проект с вашего компьютера на ВМ (через rsync или tar).
7. На ВМ запускает скрипт `setup-on-vm.sh`: создаёт `.env` и `secrets.env`, подставляет `BASE_URL` по IP ВМ и запускает `deploy.sh --build`.

В конце скрипт выведет что-то вроде:

```text
Откройте в браузере: http://<ПУБЛИЧНЫЙ_IP>:8000/login
```

**Важно:** запомните или сохраните этот IP — он понадобится для входа и для открытия порта (часть 3).

**Если скрипт спросит пароль или ключ:** это SSH-доступ к ВМ. Обычно используется ваш локальный SSH-ключ (`~/.ssh/id_rsa` или `~/.ssh/id_ed25519`). Если ключа нет — скрипт может предложить создать ВМ с паролем; следуйте подсказкам на экране.

---

## Часть 3. Открытие порта 8000 в Yandex Cloud

Чтобы до приложения можно было достучаться из интернета по адресу `http://<IP>:8000`, порт 8000 должен быть открыт в группе безопасности ВМ.

### Шаг 3.1. Открыть консоль Yandex Cloud

1. В браузере откройте: **https://console.cloud.yandex.ru**
2. Войдите в тот же аккаунт и выберите тот же **каталог**, что и в `yc init`.

---

### Шаг 3.2. Перейти в раздел «Группы безопасности»

1. В левом меню выберите **«Сеть»** (или **«VPC»**).
2. В подменю выберите **«Группы безопасности»**.
3. Откроется список групп. Нужна группа, к которой привязана ВМ **tg-digest**.

**Как найти:** откройте **«Compute Cloud»** → **«Виртуальные машины»**, нажмите на ВМ **tg-digest**. На странице ВМ будет указана **«Группа безопасности»** — запомните её название и вернитесь в «Сеть» → «Группы безопасности», найдите эту группу и нажмите на неё.

---

### Шаг 3.3. Добавить правило входящего трафика для порта 8000

1. В карточке группы безопасности откройте вкладку **«Правила»**.
2. Найдите блок **«Входящий трафик»** и нажмите **«Добавить правило»** (или «Создать правило»).
3. Заполните:
   - **Протокол / порт:** TCP, порт **8000** (иногда поле «Порт» или «Диапазон портов»).
   - **Источник:** CIDR **0.0.0.0/0** (доступ из любого IP) или укажите только свой IP, если нужен ограниченный доступ.
   - **Описание (необязательно):** например, `TG Digest web`.
4. Сохраните правило.

**Что делаем:** без этого правила брандмауэр Yandex Cloud не пропустит трафик на порт 8000, и страница `http://<IP>:8000/login` не откроется.

---

## Часть 4. Проверка и вход в приложение

### Шаг 4.1. Открыть страницу входа в браузере

Подставьте в ссылку **публичный IP** вашей ВМ (тот, что вывел скрипт в конце части 2):

```text
http://<ПУБЛИЧНЫЙ_IP>:8000/login
```

Пример: если IP равен `51.250.12.34`, откройте:

```text
http://51.250.12.34:8000/login
```

**Что вы должны увидеть:** страницу входа TG Digest (кнопки «Войти через Google» / «Войти через Яндекс» или форму логина — в зависимости от настроек).

---

### Шаг 4.2. Секреты и переменные окружения (если что-то не работает)

Скрипт `setup-on-vm.sh` на ВМ создаёт `.env` и `secrets.env`. Часть переменных он может взять из **переменных окружения вашего компьютера** в момент запуска `deploy-yandex-full.sh` (если скрипт так настроен), часть — из шаблонов.

Если нужны OAuth (Google/Яндекс), телеграм-бот, OpenAI и т.д.:

1. Подключитесь к ВМ по SSH (см. ниже).
2. Отредактируйте на ВМ файлы в каталоге проекта:
   - `secrets.env` — пароли, токены, OAuth client id/secret, `JWT_SECRET`, `BASE_URL`.
   - При необходимости `.env`.
3. Перезапустите контейнеры: в каталоге `docker` на ВМ выполните `docker compose up -d --build` (или как указано в README).

**Подключение по SSH к ВМ:**

```bash
ssh ubuntu@<ПУБЛИЧНЫЙ_IP>
```

(или `ssh <SSH_USER>@<ПУБЛИЧНЫЙ_IP>`, если при создании ВМ был указан другой пользователь). Публичный IP — тот же, что в ссылке на приложение.

---

## Краткая шпаргалка (только команды)

| Шаг | Действие | Команда |
|-----|----------|--------|
| 1 | Установить yc (в домашний каталог) | `curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh \| bash -s -- -i $HOME/.local/yc -a` |
| 2 | Обновить PATH в текущей сессии (или открыть новый терминал) | `source ~/.bashrc` |
| 3 | Настроить профиль yc | `yc init` |
| 4 | Перейти в каталог деплоя | `cd /home/alexey/work/hgfs_mirror/shared/analysis-methodology/tg_digest_system/tg_digest_system/docker/yandex` |
| 5 | Запустить деплой | `chmod +x deploy-yandex-full.sh` затем `./deploy-yandex-full.sh` |
| 6 | В консоли Yandex Cloud | Сеть → Группы безопасности → правило: входящий TCP 8000, 0.0.0.0/0 |
| 7 | Открыть приложение | В браузере: `http://<ПУБЛИЧНЫЙ_IP>:8000/login` |

Если на каком-то шаге появится ошибка — скопируйте её текст и сообщение, на каком шаге это произошло; по ним можно будет подсказать следующий шаг.
