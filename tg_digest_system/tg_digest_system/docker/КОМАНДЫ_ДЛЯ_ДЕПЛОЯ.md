# Команды для деплоя на 93.77.185.71

## Вариант 1: Деплой с локальной машины (через SSH)

Если у вас есть SSH доступ к серверу с локальной машины:

```bash
# 1. Перейдите в каталог docker
cd tg_digest_system/tg_digest_system/docker

# 2. Запустите скрипт деплоя (он скопирует код и запустит установку на ВМ)
PUBLIC_IP=93.77.185.71 SSH_USER=yc-user ./yandex/deploy-to-existing-vm.sh
```

Скрипт автоматически:
- Скопирует весь проект на сервер
- Запустит установку и деплой на ВМ
- Создаст/обновит `.env` и `secrets.env` если их нет
- Подставит `BASE_URL` по IP
- Включит авторизацию (`AUTH_OWN_ENABLED=1`)

**После деплоя подключитесь по SSH и заполните `secrets.env`:**

```bash
ssh yc-user@93.77.185.71
cd ~/tg_digest_system/docker
nano secrets.env
```

Добавьте/проверьте:
```bash
AUTH_OWN_ENABLED=1
BASE_URL=http://93.77.185.71:8000
JWT_SECRET=<длинная_случайная_строка_минимум_32_символа>
YANDEX_OAUTH_CLIENT_ID=<ваш_client_id>
YANDEX_OAUTH_CLIENT_SECRET=<ваш_client_secret>
PGPASSWORD=<пароль_postgres>
TG_API_ID=<ваш_api_id>
TG_API_HASH=<ваш_api_hash>
OPENAI_API_KEY=<ваш_openai_key>
```

Затем перезапустите web:
```bash
docker compose up -d --force-recreate web
```

---

## Вариант 2: Деплой напрямую на сервере (если код уже там)

Если код уже на сервере (например, через git pull или rsync):

```bash
# 1. Подключитесь по SSH
ssh yc-user@93.77.185.71

# 2. Перейдите в каталог docker
cd ~/tg_digest_system/docker
# или если код в другом месте:
# cd /path/to/tg_digest_system/tg_digest_system/docker

# 3. Обновите код (если нужно)
git pull
# или если нет git:
# rsync -avz user@local:/path/to/tg_digest_system/ ./

# 4. Создайте/обновите secrets.env
if [ ! -f secrets.env ]; then
  cp secrets.env.example secrets.env
fi
nano secrets.env
```

**Заполните обязательные параметры:**
```bash
AUTH_OWN_ENABLED=1
BASE_URL=http://93.77.185.71:8000
JWT_SECRET=<длинная_случайная_строка_минимум_32_символа>
YANDEX_OAUTH_CLIENT_ID=<ваш_client_id>
YANDEX_OAUTH_CLIENT_SECRET=<ваш_client_secret>
PGPASSWORD=<пароль_postgres>
TG_API_ID=<ваш_api_id>
TG_API_HASH=<ваш_api_hash>
OPENAI_API_KEY=<ваш_openai_key>
```

**5. Примените миграции (если БД уже существует):**
```bash
docker compose run --rm migrate
```

**6. Запустите/перезапустите сервисы:**
```bash
docker compose up -d --force-recreate web worker
```

**7. Проверьте логи:**
```bash
docker compose logs -f web
```

**8. Проверьте работу:**
```bash
curl http://localhost:8000/health
```

---

## Полный список команд для копирования (Вариант 2)

```bash
# Подключение
ssh yc-user@93.77.185.71

# Переход в каталог
cd ~/tg_digest_system/docker

# Обновление кода (если нужно)
git pull || echo "Код уже актуален"

# Создание secrets.env если нет
[ ! -f secrets.env ] && cp secrets.env.example secrets.env

# Редактирование secrets.env (заполните вручную)
nano secrets.env

# Применение миграций
docker compose run --rm migrate

# Перезапуск сервисов
docker compose up -d --force-recreate web worker

# Проверка логов
docker compose logs -f web
```

---

## Что нужно заполнить в secrets.env

**Обязательно для авторизации:**
- `AUTH_OWN_ENABLED=1` — включить авторизацию
- `BASE_URL=http://93.77.185.71:8000` — адрес сервиса (без слэша в конце!)
- `JWT_SECRET=<случайная_строка_32+_символов>` — секрет для JWT токенов
- `YANDEX_OAUTH_CLIENT_ID=<из_кабинета_oauth_яндекс>`
- `YANDEX_OAUTH_CLIENT_SECRET=<из_кабинета_oauth_яндекс>`

**Обязательно для работы:**
- `PGPASSWORD=<пароль_postgres>`
- `TG_API_ID=<из_my.telegram.org>`
- `TG_API_HASH=<из_my.telegram.org>`
- `OPENAI_API_KEY=<ваш_openai_key>`

**Опционально:**
- `TG_BOT_TOKEN=<токен_бота>` — для уведомлений
- `TG_STEP_NOTIFY_CHAT_ID=<id_чата>` — куда слать уведомления

---

## Проверка после деплоя

1. **Откройте в браузере:** http://93.77.185.71:8000/
2. **Должен произойти редирект на:** http://93.77.185.71:8000/login
3. **Нажмите "Войти через Яндекс"**
4. **После входа откроется главная страница**

Если редирект не происходит — проверьте логи:
```bash
docker compose logs web | grep -i auth
```

---

## Устранение проблем

**Проблема:** Редирект на `/login` не происходит  
**Решение:** 
```bash
# Проверьте что AUTH_OWN_ENABLED=1 в secrets.env
grep AUTH_OWN_ENABLED secrets.env
# Перезапустите web
docker compose up -d --force-recreate web
```

**Проблема:** "Ошибка входа через Yandex"  
**Решение:**
- Проверьте что `BASE_URL` точно совпадает с адресом в браузере (без слэша)
- Проверьте Callback URI в кабинете OAuth Яндекс: `http://93.77.185.71:8000/auth/yandex/callback`
- Перезапустите web после изменений

**Проблема:** Кнопка "Войти через Яндекс" не видна  
**Решение:**
```bash
# Проверьте что заданы OAuth параметры
grep YANDEX_OAUTH secrets.env
# Перезапустите web
docker compose up -d --force-recreate web
```
