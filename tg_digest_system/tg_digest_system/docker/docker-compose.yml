# ==============================================================================
# TG Digest System - Docker Compose
# ==============================================================================
# Запуск: docker-compose up -d
# Логи:   docker-compose logs -f worker   или  docker-compose logs -f web
# Стоп:   docker-compose down
# Деплой: см. deploy.sh и DEPLOY.md
# ==============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database (с pgvector для RAG)
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: tg_digest_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${PGDATABASE:-tg_digest}
      POSTGRES_USER: ${PGUSER:-tg_digest}
      POSTGRES_PASSWORD: ${PGPASSWORD:-tg_digest_local}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../db/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    ports:
      # Порт на хосте: по умолчанию 5433 (проверен; 5432 часто занят системным PostgreSQL)
      - "${POSTGRES_BIND_ADDRESS:-127.0.0.1}:${POSTGRES_HOST_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PGUSER:-tg_digest} -d ${PGDATABASE:-tg_digest}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tg_digest_net

  # ---------------------------------------------------------------------------
  # Миграции БД (001–005). Запускается после postgres, затем завершается.
  # ---------------------------------------------------------------------------
  migrate:
    image: pgvector/pgvector:pg16
    container_name: tg_digest_migrate
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: postgres
      PGPORT: "5432"
      PGDATABASE: ${PGDATABASE:-tg_digest}
      PGUSER: ${PGUSER:-tg_digest}
      PGPASSWORD: ${PGPASSWORD:-tg_digest_local}
    volumes:
      - ../db/schema.sql:/schema.sql:ro
      - ../db/migrations:/migrations:ro
    command:
      - sh
      - -c
      - |
        set -e
        echo "Applying base schema if needed..."
        psql -v ON_ERROR_STOP=1 -h $$PGHOST -U $$PGUSER -d $$PGDATABASE -f /schema.sql || true
        for f in /migrations/001_add_user_id.sql /migrations/002_add_user_sessions.sql /migrations/003_add_prompt_texts.sql /migrations/004_add_prompts_table.sql /migrations/005_prompt_library.sql /migrations/006_entity_settings_and_bots.sql /migrations/007_oauth_identities_audit.sql /migrations/008_delivery_settings.sql /migrations/009_user_runtime_and_prompt_sharing.sql /migrations/010_local_login_password_auth.sql; do
          [ -f "$$f" ] && echo "Running $$f" && psql -v ON_ERROR_STOP=1 -h $$PGHOST -U $$PGUSER -d $$PGDATABASE -f "$$f"
        done
        echo Migrations done.
    networks:
      - tg_digest_net

  # ---------------------------------------------------------------------------
  # Web (FastAPI) — веб-интерфейс добавления каналов, промпты, проверки
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    container_name: tg_digest_web
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    env_file:
      - .env
      - secrets.env
    environment:
      PGHOST: postgres
      PGPORT: "5432"
      PGDATABASE: ${PGDATABASE:-tg_digest}
      PGUSER: ${PGUSER:-tg_digest}
      PGPASSWORD: ${PGPASSWORD}
      PROMPTS_DIR: /app/prompts
      # Telegram credentials загружаются из secrets.env через env_file
      TG_SESSION_FILE: /app/data/telethon.session
      REPO_DIR: ${REPO_DIR:-/app/repo}
      # Авторизация: OAuth (Яндекс) + свои JWT — BASE_URL, JWT_SECRET, YANDEX_OAUTH_* только из env_file (secrets.env)
      AUTH_OWN_ENABLED: ${AUTH_OWN_ENABLED:-1}
    volumes:
      - ../prompts:/app/prompts:ro
      - worker_data:/app/data:rw
      - ..:/app/repo:ro
    ports:
      - "${WEB_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    networks:
      - tg_digest_net

  # ---------------------------------------------------------------------------
  # Digest Worker (основной сервис)
  # ---------------------------------------------------------------------------
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tg_digest_worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
      - secrets.env
    environment:
      # Telegram (загружается из secrets.env через env_file)
      TG_SESSION_FILE: /app/data/telethon.session
      # PostgreSQL
      PGHOST: postgres
      PGPORT: "5432"
      PGDATABASE: ${PGDATABASE:-tg_digest}
      PGUSER: ${PGUSER:-tg_digest}
      PGPASSWORD: ${PGPASSWORD}
      # OpenAI и прокси загружаются из secrets.env через env_file:
      # OPENAI_API_KEY, OPENAI_MODEL, OPENAI_MAX_TOKENS, OPENAI_TEMPERATURE
      # HTTPS_PROXY, HTTP_PROXY
      # Пути
      CONFIG_FILE: /app/config/channels.json
      PROMPTS_DIR: /app/prompts
      LOGS_DIR: /app/logs
      MEDIA_DIR: /app/media
      # Настройки
      TZ: ${TZ:-Europe/Moscow}
      DEBUG: ${DEBUG:-0}
      # GitLab (gitlab.ripas.ru): пуш дайджестов и сводных документов
      GITLAB_ENABLED: ${GITLAB_ENABLED:-0}
      GITLAB_REPO_URL: ${GITLAB_REPO_URL:-}
      GITLAB_BRANCH: ${GITLAB_BRANCH:-main}
      GITLAB_SSH_KEY: ${GITLAB_SSH_KEY:-}
      # Для GitLab push: repo_dir должен указывать на монтированный репо (с .git)
      REPO_DIR: ${REPO_DIR:-/app/repo}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Для доступа к хосту из контейнера
    volumes:
      # Конфигурация и промпты из репо (../ от docker/)
      - ../config:/app/config:ro
      - ../prompts:/app/prompts:ro
      # Репозиторий для GitLab push: дайджесты и сводные доки пишутся в docs/, затем git push
      # При деплое: клонируйте репо в /opt/tg_digest и запускайте из docker/; тогда .. = репо с .git
      - ..:/app/repo:rw
      # Данные (персистентные)
      - worker_data:/app/data
      - worker_logs:/app/logs
      - worker_media:/app/media
    # По умолчанию запуск каждые 30 минут
    command: ["--interval", "30"]
    networks:
      - tg_digest_net

  # ---------------------------------------------------------------------------
  # Телетон авторизация (одноразовый запуск)
  # ---------------------------------------------------------------------------
  # Используйте для первичной авторизации:
  # docker-compose run --rm auth
  # ---------------------------------------------------------------------------
  auth:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: tg_digest_auth
    profiles:
      - tools
    env_file:
      - .env
      - secrets.env
    environment:
      TG_SESSION_FILE: /app/data/telethon.session
    volumes:
      - worker_data:/app/data
    entrypoint: python
    command: ["/app/scripts/auth_telethon.py"]
    stdin_open: true
    tty: true
    networks:
      - tg_digest_net

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    name: tg_digest_postgres_data
  worker_data:
    name: tg_digest_worker_data
  worker_logs:
    name: tg_digest_worker_logs
  worker_media:
    name: tg_digest_worker_media

# -----------------------------------------------------------------------------
# Networks
# -----------------------------------------------------------------------------
networks:
  tg_digest_net:
    name: tg_digest_network
