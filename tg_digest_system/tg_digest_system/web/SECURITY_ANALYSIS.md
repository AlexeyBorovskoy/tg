# –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞—â–∏—Ç—ã –∫–∞–Ω–∞–ª–æ–≤

## –¢–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞

### ‚úÖ –ß—Ç–æ –∑–∞—â–∏—â–µ–Ω–æ:

1. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**
   - –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ `user_id`
   - –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∫–∞–Ω–∞–ª—ã
   - –í –ë–î –µ—Å—Ç—å `UNIQUE(user_id, telegram_chat_id)` - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã

2. **–û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞—â–∏—â–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–æ–π user_id:**
   - ‚úÖ **GET /api/channels** - —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ `WHERE wc.user_id = %s`
   - ‚úÖ **POST /api/channels** - —Å–æ–∑–¥–∞—ë—Ç –∫–∞–Ω–∞–ª —Å `user_id` —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - ‚úÖ **DELETE /api/channels/{id}** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `WHERE id = %s AND user_id = %s`
   - ‚úÖ **GET /api/digests/{id}** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - ‚úÖ **GET /api/channels/{id}/document** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

3. **–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∫–∞–Ω–∞–ª**
   - ‚ùå –ù–µ—Ç endpoint –¥–ª—è UPDATE (PUT/PATCH)
   - ‚ùå –ù–µ—Ç —Ñ–æ—Ä–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
   - –ö–∞–Ω–∞–ª—ã –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å

4. **–ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î:**
   - –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏–º–µ—é—Ç `user_id` —Å NOT NULL
   - –ò–Ω–¥–µ–∫—Å—ã –ø–æ `user_id` –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
   - Foreign key constraints –Ω–∞ `user_id`

### ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:

1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å user_telegram_id –≤ query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å –ª—é–±–æ–π `user_telegram_id` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
   - –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–Ω–∞–µ—Ç Telegram ID –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –º–æ–∂–µ—Ç:
     - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –∫–∞–Ω–∞–ª—ã
     - –£–¥–∞–ª–∏—Ç—å –µ–≥–æ –∫–∞–Ω–∞–ª—ã (–µ—Å–ª–∏ –∑–Ω–∞–µ—Ç channel_id)
   
   **–ó–∞—â–∏—Ç–∞:** HTTP Basic Auth –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É, –Ω–æ –≤–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã –Ω–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏ Basic Auth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ Telegram ID.

2. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø—Ä–∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö**
   - –°–∏—Å—Ç–µ–º–∞ –¥–æ–≤–µ—Ä—è–µ—Ç `user_telegram_id` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
   - –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∞–¥–µ–µ—Ç —ç—Ç–∏–º Telegram ID

### üîí –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è –∑–∞—â–∏—Ç—ã:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–∏–≤—è–∑–∞—Ç—å Basic Auth –∫ Telegram ID (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Basic Auth –∫–∞–∫ Telegram ID:

```python
# –í web_api.py
from fastapi import Request

async def get_current_user(request: Request) -> int:
    """–ü–æ–ª—É—á–∞–µ—Ç Telegram ID –∏–∑ Basic Auth username"""
    # Nginx –ø–µ—Ä–µ–¥–∞—ë—Ç –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ X-Remote-User
    remote_user = request.headers.get("X-Remote-User")
    if not remote_user:
        raise HTTPException(status_code=401, detail="–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω")
    
    try:
        telegram_id = int(remote_user)
        return telegram_id
    except ValueError:
        raise HTTPException(status_code=400, detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Telegram ID")
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Basic Auth –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å Telegram ID
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Basic Auth –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ Telegram ID

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –∏–∑ –ë–î

–•—Ä–∞–Ω–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É Basic Auth –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏ Telegram ID –≤ –ë–î:

```sql
CREATE TABLE basic_auth_users (
    id SERIAL PRIMARY KEY,
    basic_auth_username TEXT UNIQUE NOT NULL,
    telegram_id INTEGER UNIQUE NOT NULL REFERENCES users(telegram_id),
    created_at TIMESTAMPTZ DEFAULT now()
);
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å (–¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

–ï—Å–ª–∏ –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏:
- –¢–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞
- Basic Auth –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –í–Ω—É—Ç—Ä–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å–≤–æ–∏–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –î–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ç–µ–∫—É—â–∏–π —Å–ª—É—á–∞–π):
‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–∞—â–∏—â–µ–Ω–æ:**
- Basic Auth –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ user_id —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç—å —á—É–∂–∏–µ –∫–∞–Ω–∞–ª—ã (–Ω–µ—Ç UPDATE endpoint)
- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—â–∏—â–µ–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–æ–π user_id

### –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
‚ö†Ô∏è **–¢—Ä–µ–±—É–µ—Ç—Å—è —É—Å–∏–ª–µ–Ω–∏–µ:**
- –ü—Ä–∏–≤—è–∑–∞—Ç—å Basic Auth –∫ Telegram ID
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –∏–∑ –ë–î
- –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—â–∏—Ç—ã –∫–∞–Ω–∞–ª–æ–≤

‚úÖ **–í–∞—à–∏ –∫–∞–Ω–∞–ª—ã –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ user_id)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–Ω–µ—Ç UPDATE endpoint)
- –£–¥–∞–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ user_id –≤ DELETE)
- –î–æ—Å—Ç—É–ø–∞ –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ user_id)

‚ö†Ô∏è **–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å:**
- –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –∑–Ω–∞–µ—Ç –≤–∞—à Telegram ID –∏ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–∞–π—Ç—É (—á–µ—Ä–µ–∑ Basic Auth), –æ–Ω –º–æ–∂–µ—Ç —É–∫–∞–∑–∞—Ç—å –≤–∞—à Telegram ID –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —ç—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

–î–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å, –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) **—Ç–µ–∫—É—â–∞—è –∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞**.

–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä—É–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–í–∞—Ä–∏–∞–Ω—Ç 1** (–ø—Ä–∏–≤—è–∑–∫–∞ Basic Auth –∫ Telegram ID).
