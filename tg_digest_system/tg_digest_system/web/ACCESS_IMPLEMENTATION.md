# Реализация доступа к чатам клиентов

## Реализованное решение: Гибридный подход

Система использует **три метода доступа** к чатам в порядке приоритета:

### 1. Bot API (приоритет 1)
- Если бот добавлен в чат как администратор
- Используется `TG_BOT_TOKEN` для чтения сообщений через Bot API
- Работает для публичных каналов и групп где бот админ

### 2. Системная Telethon сессия (приоритет 2)
- Если система (владелец `TG_SESSION_FILE`) состоит в чате
- Используется существующая Telethon сессия
- Работает для всех типов чатов где система состоит

### 3. Доверие клиенту (Fallback)
- Если ни бот, ни система не имеют доступа
- Канал добавляется, но помечается как `requires_setup`
- Клиент получает инструкции по добавлению бота
- Система будет пытаться читать сообщения, при ошибке помечает канал как недоступный

## Изменения в коде

### База данных

Добавлены поля в `web_channels`:
- `access_method` - метод доступа (`bot`, `system_session`, `user_session`)
- `access_status` - статус доступа (`pending`, `available`, `unavailable`, `requires_setup`)
- `bot_required` - требуется ли добавление бота
- `setup_instructions` - инструкции для клиента

### Backend (`web_api.py`)

1. **`check_chat_access_via_bot()`** - проверка через Bot API
2. **`check_chat_access_via_session()`** - проверка через системную сессию
3. **`check_chat_access()`** - гибридная проверка с fallback

### Frontend

- Предупреждение на главной странице о необходимости добавления бота для приватных групп
- Отображение метода доступа в списке каналов
- Предупреждение если канал требует настройки

## Как это работает для клиента

### Сценарий 1: Публичный канал
1. Клиент добавляет канал через веб-интерфейс
2. Система проверяет доступ через бота → успех
3. Канал помечается как `access_method=bot`, `access_status=available`
4. Воркер начинает читать сообщения через Bot API

### Сценарий 2: Приватная группа (бот не добавлен)
1. Клиент добавляет группу через веб-интерфейс
2. Система проверяет доступ:
   - Через бота → нет доступа
   - Через системную сессию → нет доступа
3. Канал добавляется с `access_method=user_session`, `access_status=requires_setup`
4. Клиент получает инструкции по добавлению бота
5. После добавления бота система автоматически обнаружит доступ и начнёт работу

### Сценарий 3: Группа где система состоит
1. Клиент добавляет группу
2. Система проверяет доступ через системную сессию → успех
3. Канал помечается как `access_method=system_session`, `access_status=available`
4. Воркер читает сообщения через Telethon сессию

## Следующие шаги (для полной реализации)

### 1. Поддержка Bot API в воркере

Нужно модифицировать `telegram_client.py` для чтения через Bot API:

```python
async def fetch_messages_via_bot(self, channel: ChannelConfig, last_msg_id: int):
    """Читает сообщения через Bot API"""
    # Использовать python-telegram-bot или requests к Bot API
    # https://api.telegram.org/bot{token}/getUpdates
    pass
```

### 2. Автоматическая проверка доступа

Добавить периодическую проверку каналов со статусом `requires_setup`:
- Раз в час проверять доступ через бота
- Если доступ появился - обновить статус на `available`

### 3. Уведомления клиента

При изменении статуса доступа отправлять уведомление клиенту:
- Когда бот добавлен и канал начал работать
- Когда доступ потерян (бот удалён из чата)

## Текущее состояние

✅ **Реализовано:**
- Гибридная проверка доступа при добавлении канала
- Сохранение метода доступа в БД
- Отображение статуса в веб-интерфейсе
- Инструкции для клиента

⚠️ **Требует доработки:**
- Чтение сообщений через Bot API в воркере (сейчас только через Telethon)
- Автоматическая проверка доступа для каналов `requires_setup`
- Уведомления клиента об изменении статуса

## Временное решение

Пока чтение через Bot API не реализовано в воркере:
- Каналы с `access_method=bot` будут работать только если система имеет доступ через сессию
- Клиентам с приватными группами нужно либо:
  1. Добавить бота в группу (после реализации Bot API)
  2. Или убедиться что системная сессия состоит в группе

Это временное ограничение будет устранено после реализации чтения через Bot API.
