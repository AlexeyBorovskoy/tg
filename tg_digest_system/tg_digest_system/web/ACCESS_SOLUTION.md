# Решение проблемы доступа к чатам клиентов

## Проблема

Текущая система использует одну Telethon сессию (`TG_SESSION_FILE`) для доступа ко всем чатам. Это означает что система может читать только те чаты, где зарегистрирован владелец этой сессии. Клиенты могут хотеть мониторить чаты, в которых система не состоит.

## Решения

### Вариант 1: Использование бота (Рекомендуется)

**Как работает:**
- Клиент добавляет бота в чат/канал как администратора
- Бот получает права на чтение сообщений
- Система использует Bot API для чтения сообщений

**Преимущества:**
- ✅ Безопасно (не нужны credentials клиента)
- ✅ Централизованное управление
- ✅ Работает для публичных каналов и групп

**Ограничения:**
- ❌ Бот должен быть добавлен в чат клиентом
- ❌ Для приватных групп нужны права администратора

**Реализация:**
1. Добавить поле `access_method` в `web_channels` (bot/user_session)
2. Модифицировать `telegram_client.py` для поддержки Bot API
3. При добавлении канала проверять доступ через бота
4. Если бот не имеет доступа - требовать от клиента добавить бота

### Вариант 2: Доверие клиенту (Простое решение)

**Как работает:**
- Убрать строгую проверку доступа при добавлении канала
- Клиент сам подтверждает что у него есть доступ
- Система пытается читать сообщения, если не получается - помечает канал как недоступный

**Преимущества:**
- ✅ Простая реализация
- ✅ Гибкость для клиентов

**Ограничения:**
- ❌ Нет предварительной проверки доступа
- ❌ Ошибки обнаруживаются только при попытке чтения

**Реализация:**
1. Ослабить проверку `check_chat_access()` - возвращать успех если чат существует
2. Добавить поле `access_status` в `web_channels` (available/unavailable)
3. При ошибке чтения сообщений помечать канал как недоступный

### Вариант 3: Гибридный подход (Лучшее решение)

**Как работает:**
1. **Публичные каналы** - использовать бота (если он админ)
2. **Приватные группы** - использовать системную сессию или доверять клиенту
3. **Fallback** - если бот не имеет доступа, требовать от клиента добавить бота или использовать системную сессию

**Реализация:**
1. Проверять доступ через бота (Bot API)
2. Если бот не имеет доступа - проверять через системную сессию
3. Если и системная сессия не имеет доступа - помечать канал как "требует настройки"
4. Клиент получает инструкции как добавить бота в чат

## Рекомендуемое решение: Гибридный подход

### Архитектура:

```
┌─────────────────────────────────────────┐
│  Клиент добавляет канал               │
└──────────────┬──────────────────────────┘
               │
               ▼
┌─────────────────────────────────────────┐
│  1. Проверка через Bot API             │
│     (если бот админ в чате)            │
└──────────────┬──────────────────────────┘
               │
               ├─ Успех → Использовать бота
               │
               ▼
┌─────────────────────────────────────────┐
│  2. Проверка через системную сессию   │
│     (Telethon)                          │
└──────────────┬──────────────────────────┘
               │
               ├─ Успех → Использовать сессию
               │
               ▼
┌─────────────────────────────────────────┐
│  3. Fallback: Требовать настройку     │
│     - Инструкции по добавлению бота    │
│     - Или использовать user_session    │
└─────────────────────────────────────────┘
```

### Изменения в БД:

```sql
ALTER TABLE web_channels 
ADD COLUMN access_method TEXT DEFAULT 'bot' CHECK (access_method IN ('bot', 'user_session', 'system_session')),
ADD COLUMN access_status TEXT DEFAULT 'pending' CHECK (access_status IN ('pending', 'available', 'unavailable', 'requires_setup')),
ADD COLUMN bot_required BOOLEAN DEFAULT true;
```

### Изменения в коде:

1. **web_api.py** - модифицировать `check_chat_access()`:
   - Сначала проверять через Bot API
   - Затем через системную сессию
   - Возвращать метод доступа и статус

2. **telegram_client.py** - добавить поддержку Bot API:
   - Метод `fetch_messages_via_bot()` для чтения через бота
   - Метод `fetch_messages_via_session()` для чтения через сессию

3. **digest_worker.py** - выбирать метод доступа в зависимости от `access_method` канала

## Временное решение (быстрое)

Для быстрого запуска можно использовать **Вариант 2** (доверие клиенту):

1. Убрать строгую проверку доступа
2. Добавить предупреждение клиенту что он должен убедиться что система имеет доступ
3. При ошибке чтения помечать канал как недоступный и уведомлять клиента

Это позволит быстро запустить систему, а затем доработать до гибридного подхода.
