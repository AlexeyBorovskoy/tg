# Редактирование промптов через веб-интерфейс

## Возможности

Теперь вы можете редактировать промпты для генерации дайджестов и сводных инженерных документов прямо через веб-интерфейс.

## Как использовать

### 1. Открыть страницу редактирования промптов

1. Откройте список каналов: `http://tg-digest.158.160.19.253.nip.io/channels`
2. Найдите нужный канал в таблице
3. Нажмите кнопку **"Промпты"** в колонке "Действия"

### 2. Редактировать промпты

На странице редактирования вы увидите два редактора:

- **Промпт для дайджестов** — используется для генерации периодических дайджестов
- **Промпт для сводного документа** — используется для генерации/обновления сводного инженерного документа

### 3. Сохранить изменения

1. Отредактируйте текст промпта в соответствующем редакторе
2. Нажмите кнопку **"Сохранить промпт дайджестов"** или **"Сохранить промпт сводного документа"**
3. Дождитесь сообщения об успешном сохранении

## Технические детали

### Хранение промптов

- Промпты хранятся в БД в полях `prompt_text` и `consolidated_doc_prompt_text` таблицы `web_channels`
- Если промпт не задан в БД, система загружает его из файла (указанного в `prompt_file` или `consolidated_doc_prompt_file`)
- После сохранения промпта в БД, он имеет приоритет над файлом

### API Endpoints

- `GET /api/channels/{channel_id}/prompts?user_telegram_id=X` — получить промпты канала
- `PUT /api/channels/{channel_id}/prompts` — обновить промпты канала

### Безопасность

- Все операции проверяют принадлежность канала пользователю (`user_id`)
- Только владелец канала может редактировать его промпты
- Промпты изолированы по пользователям (мультитенантность)

## Миграция БД

Для работы функции была добавлена миграция `003_add_prompt_texts.sql`, которая:
- Добавляет поля `prompt_text` и `consolidated_doc_prompt_text` в таблицу `web_channels`
- Создаёт индекс для быстрого поиска каналов с кастомными промптами

## Следующие шаги

Для полной интеграции нужно обновить воркер (`digest_worker.py`), чтобы он использовал промпты из БД вместо файлов, если они заданы.
