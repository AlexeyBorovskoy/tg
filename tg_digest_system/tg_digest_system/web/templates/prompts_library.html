<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/platform_shell.css">
    <script src="/static/platform_shell.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Библиотека промптов — TG Digest</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #edf1f5;
            color: #26323f;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #d7dde6;
            padding: 0 18px;
            height: 54px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .title {
            font-size: 16px;
            font-weight: 600;
            color: #2f3b48;
            margin-right: auto;
        }

        .tabs {
            background: #fff;
            border-bottom: 1px solid #d7dde6;
            display: flex;
            padding: 0 14px;
        }

        .tab {
            text-decoration: none;
            color: #6e7b88;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: .04em;
            padding: 12px 12px;
            border-bottom: 2px solid transparent;
            text-transform: uppercase;
        }

        .tab.active {
            color: #2f6ea6;
            border-bottom-color: #2f6ea6;
        }

        .container {
            max-width: 1500px;
            margin: 14px auto;
            padding: 0 16px;
        }

        .page-head {
            background: #fff;
            border: 1px solid #d7dde6;
            border-radius: 6px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }

        .page-head h1 {
            margin: 0 0 6px;
            font-size: 21px;
            font-weight: 600;
            color: #2d3a47;
        }

        .page-head p {
            margin: 0;
            font-size: 13px;
            color: #6c7887;
        }

        .workspace {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .panel {
            background: #fff;
            border: 1px solid #d7dde6;
            border-radius: 6px;
            min-height: 540px;
        }

        .panel-head {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8ef;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .panel-head h2,
        .panel-head h3 {
            margin: 0;
            font-size: 13px;
            font-weight: 700;
            color: #344252;
            text-transform: uppercase;
            letter-spacing: .04em;
            margin-right: auto;
        }

        .btn {
            border: 1px solid #c8d2dd;
            background: #f7fafc;
            color: #344252;
            border-radius: 4px;
            padding: 7px 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn.primary {
            background: #2f6ea6;
            border-color: #2f6ea6;
            color: #fff;
        }

        .btn.secondary {
            background: #eef3f8;
        }

        .filters {
            display: flex;
            gap: 6px;
            padding: 10px 10px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            border: 1px solid #d0d8e3;
            background: #fff;
            color: #4f6072;
            border-radius: 4px;
            padding: 6px 9px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .filter-btn.active {
            background: #dfeaf6;
            border-color: #9fb9d6;
            color: #2b5f8f;
        }

        .templates-list {
            max-height: 460px;
            overflow: auto;
            padding: 8px 10px 12px;
        }

        .template-item {
            border: 1px solid #dde4ec;
            border-radius: 4px;
            padding: 8px 9px;
            margin-bottom: 8px;
            background: #fbfcfe;
            cursor: pointer;
        }

        .template-item.active {
            background: #e7f0fa;
            border-color: #98b6d6;
        }

        .template-item h4 {
            margin: 0 0 4px;
            font-size: 13px;
            color: #283746;
            font-weight: 600;
        }

        .template-meta {
            font-size: 11px;
            color: #66798b;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pill {
            background: #f0f4f9;
            border: 1px solid #d4dde8;
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
            color: #4f6276;
            font-weight: 600;
        }

        .panel-body {
            padding: 12px;
        }

        .selected-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .full-prompt {
            width: 100%;
            min-height: 430px;
            border: 1px solid #cad4df;
            border-radius: 4px;
            padding: 10px;
            font-size: 13px;
            line-height: 1.5;
            font-family: 'Consolas', 'Courier New', monospace;
            resize: vertical;
            background: #fff;
            color: #253341;
        }

        .editor-card {
            background: #fff;
            border: 1px solid #d7dde6;
            border-radius: 6px;
            padding: 14px;
        }

        .editor-card h3 {
            margin: 0 0 10px;
            font-size: 16px;
            color: #2f3d4b;
        }

        .form-row {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 700;
            color: #4f6073;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: .03em;
        }

        input,
        select,
        textarea {
            width: 100%;
            border: 1px solid #c8d3de;
            border-radius: 4px;
            padding: 9px 10px;
            font-size: 13px;
            color: #273746;
            background: #fff;
            font-family: inherit;
        }

        textarea#promptBody {
            min-height: 260px;
            resize: vertical;
            line-height: 1.5;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .hint {
            margin-top: 3px;
            font-size: 12px;
            color: #6f7d8b;
        }

        .alert {
            margin-top: 10px;
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid;
            display: none;
        }

        .alert.ok {
            background: #ecf7f1;
            border-color: #b7dec9;
            color: #2d6b4a;
            display: block;
        }

        .alert.err {
            background: #fff1f1;
            border-color: #e7c0c0;
            color: #8f3434;
            display: block;
        }

        .empty {
            padding: 18px 12px;
            font-size: 13px;
            color: #6b7988;
        }

        @media (max-width: 1240px) {
            .workspace {
                grid-template-columns: 1fr;
            }

            .full-prompt {
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="title">Платформа TG Digest</div>
    </header>
    <div class="tabs">
        <a class="tab" href="/setup">Настройка</a>
        <a class="tab" href="/">Добавление канала</a>
        <a class="tab" href="/channels">Мои каналы</a>
        <a class="tab active" href="/prompts">Промпты</a>
        <a class="tab" href="/instructions">Инструкции</a>
        <a class="tab" href="/users">Пользователи</a>
    </div>

    <main class="container">
        <section class="page-head">
            <h1>Библиотека промптов</h1>
            <p>Вы видите системные промпты по умолчанию, публичные и личные. Полный текст выбранного промпта отображается справа без обрезки.</p>
        </section>

        <section class="workspace">
            <article class="panel">
                <div class="panel-head">
                    <h2>Список промптов</h2>
                    <button class="btn secondary" id="syncBtn" type="button">Синхронизировать defaults</button>
                    <button class="btn" id="reloadBtn" type="button">Обновить</button>
                </div>
                <div class="filters">
                    <button class="filter-btn active" type="button" data-filter="defaults">Системные</button>
                    <button class="filter-btn" type="button" data-filter="mine">Мои</button>
                    <button class="filter-btn" type="button" data-filter="public">Публичные</button>
                    <button class="filter-btn" type="button" data-filter="all">Все</button>
                </div>
                <div id="templatesList" class="templates-list"></div>
            </article>

            <article class="panel">
                <div class="panel-head">
                    <h3>Полный текст выбранного промпта</h3>
                    <button class="btn" id="copySelectedBtn" type="button">Копировать в форму</button>
                </div>
                <div class="panel-body">
                    <div id="selectedMeta" class="selected-meta"></div>
                    <textarea id="selectedPromptText" class="full-prompt" readonly placeholder="Выберите промпт слева"></textarea>
                </div>
            </article>
        </section>

        <section class="editor-card">
            <h3>Добавить пользовательский промпт</h3>
            <form id="newPromptForm">
                <div class="form-row">
                    <label for="promptName">Название</label>
                    <input id="promptName" type="text" placeholder="например: Моя аналитика" required>
                </div>

                <div class="form-row">
                    <label for="promptType">Тип</label>
                    <select id="promptType" required>
                        <option value="digest">Для дайджестов</option>
                        <option value="consolidated">Для сводного документа</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="promptBody">Текст промпта (полный)</label>
                    <textarea id="promptBody" placeholder="Введите полный текст промпта" required></textarea>
                    <div class="hint">Поле многострочное: текст не обрезается и сохраняется целиком.</div>
                </div>

                <div class="form-row">
                    <label for="shareToLibrary">Видимость</label>
                    <select id="shareToLibrary">
                        <option value="0">Личный (только для меня)</option>
                        <option value="1">Публичный (в общую библиотеку)</option>
                    </select>
                </div>

                <button class="btn primary" type="submit" id="createPromptBtn">Сохранить промпт</button>
                <div id="topAlert" class="alert"></div>
            </form>
        </section>
    </main>

<script>
const topAlert = document.getElementById('topAlert');
const templatesListEl = document.getElementById('templatesList');
const selectedMetaEl = document.getElementById('selectedMeta');
const selectedPromptTextEl = document.getElementById('selectedPromptText');
const copySelectedBtn = document.getElementById('copySelectedBtn');

const syncBtn = document.getElementById('syncBtn');
const reloadBtn = document.getElementById('reloadBtn');
const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
const newPromptForm = document.getElementById('newPromptForm');
const createPromptBtn = document.getElementById('createPromptBtn');

let templates = [];
let selectedTemplateId = null;
let activeFilter = 'defaults';

function showAlert(message, kind = 'ok') {
    topAlert.className = 'alert ' + kind;
    topAlert.textContent = message;
    topAlert.style.display = 'block';
}

function extractError(payload, fallback) {
    if (!payload) return fallback;
    if (typeof payload.detail === 'string') return payload.detail;
    if (typeof payload.message === 'string') return payload.message;
    return fallback;
}

function escapeHtml(value) {
    const div = document.createElement('div');
    div.textContent = value || '';
    return div.innerHTML;
}

function visibilityLabel(template) {
    if (template.is_base) return 'default';
    return template.visibility === 'public' ? 'public' : 'private';
}

function filterTemplates() {
    if (activeFilter === 'defaults') return templates.filter(t => t.is_base);
    if (activeFilter === 'mine') return templates.filter(t => t.is_mine);
    if (activeFilter === 'public') return templates.filter(t => t.visibility === 'public' && !t.is_base);
    return templates;
}

function pickTemplate(id) {
    const t = templates.find(x => x.id === id);
    if (!t) return;

    selectedTemplateId = id;
    selectedPromptTextEl.value = t.body || '';

    selectedMetaEl.innerHTML = [
        '<span class="pill">' + (t.prompt_type || '-') + '</span>',
        '<span class="pill">' + visibilityLabel(t) + '</span>',
        '<span class="pill">' + escapeHtml(t.name || 'Без названия') + '</span>'
    ].join('');

    renderList();
}

function renderList() {
    const list = filterTemplates();
    if (!list.length) {
        templatesListEl.innerHTML = '<div class="empty">Промптов в этом разделе пока нет.</div>';
        return;
    }

    templatesListEl.innerHTML = list.map(t => {
        const activeClass = t.id === selectedTemplateId ? ' active' : '';
        const label = visibilityLabel(t);
        const lineCount = (t.body || '').split(/\r?\n/).length;
        return `
            <div class="template-item${activeClass}" onclick="selectTemplate(${t.id})">
                <h4>${escapeHtml(t.name || 'Без названия')}</h4>
                <div class="template-meta">
                    <span class="pill">${escapeHtml(t.prompt_type || '-')}</span>
                    <span class="pill">${escapeHtml(label)}</span>
                    <span class="pill">строк: ${lineCount}</span>
                </div>
            </div>
        `;
    }).join('');
}
window.selectTemplate = pickTemplate;

async function loadTemplates() {
    try {
        const response = await fetch('/api/prompt-library/templates');
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Не удалось загрузить шаблоны'));
        }
        templates = data.templates || [];

        if (!templates.some(t => t.is_base)) {
            await syncDefaults(false);
            return;
        }

        const filtered = filterTemplates();
        const hasSelectedInFiltered = filtered.some(t => t.id === selectedTemplateId);
        if (!selectedTemplateId || !hasSelectedInFiltered) {
            const next = filtered[0] || templates[0] || null;
            if (next) {
                selectedTemplateId = next.id;
                pickTemplate(selectedTemplateId);
            } else {
                renderList();
                selectedMetaEl.innerHTML = '';
                selectedPromptTextEl.value = '';
            }
            return;
        }

        renderList();
        const current = templates.find(t => t.id === selectedTemplateId);
        if (current) {
            selectedPromptTextEl.value = current.body || '';
        }
    } catch (error) {
        showAlert(error.message, 'err');
    }
}

async function syncDefaults(withAlert = true) {
    try {
        const response = await fetch('/api/prompt-library/sync', { method: 'POST' });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Не удалось синхронизировать системные промпты'));
        }
        if (withAlert) {
            showAlert('Системные промпты синхронизированы: ' + (data.synced || 0), 'ok');
        }
        await loadTemplates();
    } catch (error) {
        if (withAlert) showAlert(error.message, 'err');
    }
}

function setFilter(nextFilter) {
    activeFilter = nextFilter;
    filterButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === nextFilter);
    });
    renderList();
}

async function createTemplate(event) {
    event.preventDefault();
    const name = (document.getElementById('promptName').value || '').trim();
    const promptType = document.getElementById('promptType').value;
    const body = (document.getElementById('promptBody').value || '').trim();
    const share = document.getElementById('shareToLibrary').value === '1';

    if (!name || !body) {
        showAlert('Заполните название и полный текст промпта', 'err');
        return;
    }

    createPromptBtn.disabled = true;
    createPromptBtn.textContent = 'Сохраняем...';
    try {
        const response = await fetch('/api/prompt-library/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: name,
                prompt_type: promptType,
                body: body,
                share_to_library: share,
            }),
        });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Не удалось создать шаблон'));
        }

        showAlert('Промпт сохранен', 'ok');
        newPromptForm.reset();
        document.getElementById('shareToLibrary').value = '0';
        activeFilter = 'mine';
        setFilter('mine');
        await loadTemplates();
    } catch (error) {
        showAlert(error.message, 'err');
    } finally {
        createPromptBtn.disabled = false;
        createPromptBtn.textContent = 'Сохранить промпт';
    }
}

function copySelectedToForm() {
    const current = templates.find(t => t.id === selectedTemplateId);
    if (!current) {
        showAlert('Сначала выберите промпт из списка', 'err');
        return;
    }
    document.getElementById('promptName').value = (current.name || '') + ' (копия)';
    document.getElementById('promptType').value = current.prompt_type || 'digest';
    document.getElementById('promptBody').value = current.body || '';
    document.getElementById('shareToLibrary').value = '0';
    showAlert('Текст выбранного промпта скопирован в форму', 'ok');
}

window.addEventListener('DOMContentLoaded', () => {
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => setFilter(btn.dataset.filter));
    });
    syncBtn.addEventListener('click', () => syncDefaults(true));
    reloadBtn.addEventListener('click', loadTemplates);
    copySelectedBtn.addEventListener('click', copySelectedToForm);
    newPromptForm.addEventListener('submit', createTemplate);

    setFilter('defaults');
    loadTemplates();
});
</script>
</body>
</html>
