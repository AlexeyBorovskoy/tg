<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="stylesheet" href="/static/platform_shell.css">
    <script src="/static/platform_shell.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройка Telegram — TG Digest</title>
    <link rel="stylesheet" href="/static/onboarding.css">
</head>
<body>
<div class="wrap">
    <header class="header">
        <div class="title">TG DIGEST / Личный профиль</div>
        <a class="tab active" href="/setup">Настройка Telegram</a>
        <a class="tab" href="/">Добавление канала</a>
        <a class="tab" href="/channels">Мои каналы</a>
        <a class="tab" href="/prompts">Библиотека промптов</a>
        <a class="tab" href="/instructions">Инструкции</a>
        <a class="tab" href="/logout">Выйти</a>
    </header>

    <section class="hero">
        <h1>Персональная настройка Telegram (Telethon)</h1>
        <p>Последовательность простая: 1) сохранить API-данные, 2) получить код в Telegram, 3) подтвердить код и 2FA, 4) сохранить бота/чаты.</p>
    </section>

    <section class="grid">
        <article class="card">
            <div class="meta">
                <div class="item">User ID<b id="metaUserId">{{ user_id or '-' }}</b></div>
                <div class="item">Telegram ID<b id="metaTelegramId">{{ user_telegram_id or 'не привязан' }}</b></div>
                <div class="item">Secret file<b id="metaSecretFile">не создан</b></div>
            </div>
            <div id="topAlert" class="alert" style="display:none;"></div>
        </article>
    </section>

    <section class="grid two">
        <article class="card">
            <h2>Шаг 1. API данные + бот</h2>

            <form id="runtimeForm">
                <label for="tgApiId">API ID</label>
                <input id="tgApiId" type="number" placeholder="12345678" required>
                <p class="hint">Берется на <code>my.telegram.org/apps</code> (раздел <code>API development tools</code>).</p>

                <label for="tgApiHash">API Hash</label>
                <input id="tgApiHash" type="text" placeholder="0123456789abcdef0123456789abcdef" required>

                <label for="tgPhone">Телефон Telegram</label>
                <input id="tgPhone" type="text" placeholder="+79991234567">

                {% if is_admin %}
                <label for="tgSessionFile">Файл сессии (только администратор)</label>
                <input id="tgSessionFile" type="text" placeholder="/app/data/user-sessions/user_1.session">
                <p class="hint">Путь session-файла доступен для управления только админу (login: <code>{{ admin_login }}</code>).</p>
                {% else %}
                <input id="tgSessionFile" type="hidden" value="">
                <p class="hint">Путь session-файла управляется системой и скрыт для обычного пользователя.</p>
                {% endif %}

                <label for="botToken">Токен бота (опционально)</label>
                <input id="botToken" type="text" placeholder="123456789:AA...">
                <p class="hint">На этом этапе мы проверяем формат и сохраняем токен как дефолтный для пользователя.</p>

                <label for="botName">Название бота</label>
                <input id="botName" type="text" value="Default Bot">

                <div class="btns">
                    <button class="btn main" type="submit" id="saveBtn">Сохранить настройки</button>
                    <button class="btn soft" type="button" id="reloadBtn">Обновить из БД</button>
                </div>
            </form>
        </article>

        <article class="card">
            <h3>Где взять API ID и API Hash</h3>
            <div class="alert warn" style="margin-bottom:10px;">
                Если Telegram просит "зарегистрировать разработку", это штатно: сначала нужно создать приложение, и только потом появятся <code>api_id</code> и <code>api_hash</code>.
            </div>
            <ol class="steps">
                <li>Откройте <code>https://my.telegram.org</code>.</li>
                <li>Войдите по вашему номеру и одноразовому коду Telegram.</li>
                <li>Откройте <code>API development tools</code> (или сразу <code>https://my.telegram.org/apps</code>).</li>
                <li>Если данных нет, заполните форму создания приложения:
                    <br><code>App title</code> = <code>TG Digest Alex</code>,
                    <code>Short name</code> = <code>tg_digest_alex</code>,
                    <code>Platform</code> = <code>Desktop</code>,
                    <code>URL</code> = <code>https://example.com</code>.
                </li>
                <li>Нажмите <code>Create application</code> и скопируйте значения в форму слева.</li>
            </ol>
            <div class="code">Пример:
phone    = +79991234567
api_id   = 12345678
api_hash = 0123456789abcdef0123456789abcdef</div>
            <div class="alert warn" style="margin-top:10px;">Если API данные неверные, код подтверждения не отправится.</div>
        </article>
    </section>

    <section class="grid two">
        <article class="card">
            <h2>Шаг 2. Отправка кода из Telegram</h2>
            <p class="hint">После сохранения данных нажмите кнопку ниже. Код придет в приложение Telegram на указанный номер.</p>
            <div class="btns">
                <button class="btn main" id="sendCodeBtn" type="button">Отправить код в Telegram</button>
            </div>
            <div class="hint" id="sendCodeStatus"></div>
        </article>

        <article class="card">
            <h2>Шаг 3. Подтверждение кода и 2FA</h2>
            <label for="tgCode">Код из Telegram</label>
            <input id="tgCode" type="text" placeholder="например: 12345">

            <label for="tg2fa">Пароль 2FA (если включен)</label>
            <input id="tg2fa" type="password" placeholder="если не включен — оставить пустым">

            <div class="btns">
                <button class="btn main" id="verifyCodeBtn" type="button">Подтвердить вход Telethon</button>
            </div>

            <div class="alert ok" style="margin-top:12px;" id="authResultHint">
                После успешного шага будет создан session-файл и обновлен secret-файл пользователя.
            </div>
        </article>
    </section>
</div>

<script>
const topAlert = document.getElementById('topAlert');
const metaUserId = document.getElementById('metaUserId');
const metaTelegramId = document.getElementById('metaTelegramId');
const metaSecretFile = document.getElementById('metaSecretFile');

const tgApiId = document.getElementById('tgApiId');
const tgApiHash = document.getElementById('tgApiHash');
const tgPhone = document.getElementById('tgPhone');
const tgSessionFile = document.getElementById('tgSessionFile');
const botToken = document.getElementById('botToken');
const botName = document.getElementById('botName');

const saveBtn = document.getElementById('saveBtn');
const reloadBtn = document.getElementById('reloadBtn');
const sendCodeBtn = document.getElementById('sendCodeBtn');
const verifyCodeBtn = document.getElementById('verifyCodeBtn');
const sendCodeStatus = document.getElementById('sendCodeStatus');
const tgCode = document.getElementById('tgCode');
const tg2fa = document.getElementById('tg2fa');
const authResultHint = document.getElementById('authResultHint');
const isAdmin = {{ 'true' if is_admin else 'false' }};

function setSecretFileMeta(path, generated) {
    if (isAdmin) {
        metaSecretFile.textContent = path || (generated ? 'сформирован' : 'не создан');
        return;
    }
    metaSecretFile.textContent = generated ? 'сформирован (путь скрыт)' : 'не создан';
}

function showAlert(message, kind = 'ok') {
    topAlert.className = 'alert ' + kind;
    topAlert.textContent = message;
    topAlert.style.display = 'block';
}

function hideAlert() {
    topAlert.style.display = 'none';
    topAlert.textContent = '';
}

function extractError(payload, fallback) {
    if (!payload) return fallback;
    if (typeof payload.detail === 'string') return payload.detail;
    if (typeof payload.message === 'string') return payload.message;
    if (typeof payload.detail === 'object' && payload.detail && payload.detail.message) return payload.detail.message;
    return fallback;
}

async function loadRuntimeConfig() {
    hideAlert();
    try {
        const response = await fetch('/api/user/runtime-config');
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Не удалось загрузить настройки'));
        }

        if (data.user_id) metaUserId.textContent = data.user_id;
        if (data.telegram_id) metaTelegramId.textContent = data.telegram_id;

        if (data.telegram) {
            if (data.telegram.tg_api_id) tgApiId.value = data.telegram.tg_api_id;
            if (data.telegram.tg_phone) tgPhone.value = data.telegram.tg_phone;
            if (data.telegram.tg_session_file) tgSessionFile.value = data.telegram.tg_session_file;

            if (data.telegram.session_file_exists) {
                authResultHint.className = 'alert ok';
                authResultHint.textContent = 'Telethon уже авторизован: session-файл найден.';
            }
        }

        if (data.bot && data.bot.bot_name) {
            botName.value = data.bot.bot_name;
        }

        if (data.secret_file) {
            setSecretFileMeta(data.secret_file.path, data.secret_file.generated);
        }

        if (!tgSessionFile.value && data.user_id) {
            tgSessionFile.value = '/app/data/user-sessions/user_' + data.user_id + '.session';
        }
    } catch (error) {
        showAlert(error.message, 'err');
    }
}

async function saveRuntimeConfig(event) {
    event.preventDefault();
    hideAlert();

    const apiId = parseInt((tgApiId.value || '').trim(), 10);
    const apiHash = (tgApiHash.value || '').trim();
    if (!apiId || !apiHash) {
        showAlert('Заполните API ID и API Hash', 'err');
        return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = 'Сохраняем...';
    try {
        const payload = {
            tg_api_id: apiId,
            tg_api_hash: apiHash,
            tg_phone: (tgPhone.value || '').trim() || null,
            tg_session_file: (tgSessionFile.value || '').trim() || null,
            bot_token: (botToken.value || '').trim() || null,
            bot_name: (botName.value || '').trim() || 'Default Bot',
            make_bot_default: true,
        };

        const response = await fetch('/api/user/runtime-config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Ошибка сохранения runtime-настроек'));
        }

        if (data.secret_file_path || data.secret_file_generated) {
            setSecretFileMeta(data.secret_file_path, data.secret_file_generated);
        }
        showAlert('Настройки сохранены. Теперь можно отправить код подтверждения.', 'ok');
        await loadRuntimeConfig();
    } catch (error) {
        showAlert(error.message, 'err');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Сохранить настройки';
    }
}

async function sendTelethonCode() {
    hideAlert();
    sendCodeStatus.textContent = '';
    sendCodeBtn.disabled = true;
    sendCodeBtn.textContent = 'Отправляем...';

    try {
        const response = await fetch('/api/user/telethon/send-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tg_phone: (tgPhone.value || '').trim() || null }),
        });
        const data = await response.json();
        if (!response.ok) {
            throw new Error(extractError(data, 'Не удалось отправить код'));
        }

        if (data.already_authorized) {
            authResultHint.className = 'alert ok';
            authResultHint.textContent = 'Telethon уже был авторизован. Можно переходить к добавлению каналов.';
            if (data.telegram_id) metaTelegramId.textContent = String(data.telegram_id);
            if (data.secret_file_path || data.secret_file_generated) {
                setSecretFileMeta(data.secret_file_path, data.secret_file_generated);
            }
            showAlert('Авторизация уже активна для этого пользователя.', 'ok');
        } else {
            sendCodeStatus.textContent = 'Код отправлен. Срок действия: ' + (data.ttl_seconds || 600) + ' сек.';
            showAlert('Код отправлен в Telegram. Введите его в следующем блоке.', 'ok');
        }
    } catch (error) {
        showAlert(error.message, 'err');
    } finally {
        sendCodeBtn.disabled = false;
        sendCodeBtn.textContent = 'Отправить код в Telegram';
    }
}

async function verifyTelethonCode() {
    hideAlert();
    const code = (tgCode.value || '').trim();
    if (!code) {
        showAlert('Введите код подтверждения', 'err');
        return;
    }

    verifyCodeBtn.disabled = true;
    verifyCodeBtn.textContent = 'Проверяем...';

    try {
        const response = await fetch('/api/user/telethon/verify-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                code: code,
                password: (tg2fa.value || '').trim() || null,
            }),
        });
        const data = await response.json();

        if (!response.ok) {
            if (data && data.needs_password) {
                showAlert(data.message || 'Нужен пароль 2FA', 'warn');
                return;
            }
            throw new Error(extractError(data, 'Ошибка подтверждения кода'));
        }

        if (data.telegram_id) metaTelegramId.textContent = String(data.telegram_id);
        if (data.secret_file_path || data.secret_file_generated) {
            setSecretFileMeta(data.secret_file_path, data.secret_file_generated);
        }

        authResultHint.className = 'alert ok';
        authResultHint.textContent = 'Telethon успешно подключен. Можно переходить к добавлению чатов.';
        showAlert(data.message || 'Авторизация Telethon завершена', 'ok');

        tgCode.value = '';
        tg2fa.value = '';
        await loadRuntimeConfig();
    } catch (error) {
        showAlert(error.message, 'err');
    } finally {
        verifyCodeBtn.disabled = false;
        verifyCodeBtn.textContent = 'Подтвердить вход Telethon';
    }
}

window.addEventListener('DOMContentLoaded', () => {
    document.getElementById('runtimeForm').addEventListener('submit', saveRuntimeConfig);
    reloadBtn.addEventListener('click', loadRuntimeConfig);
    sendCodeBtn.addEventListener('click', sendTelethonCode);
    verifyCodeBtn.addEventListener('click', verifyTelethonCode);
    loadRuntimeConfig();
});
</script>
</body>
</html>
