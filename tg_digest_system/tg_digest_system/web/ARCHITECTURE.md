# Архитектура веб-интерфейса TG Digest

## Обзор

Веб-интерфейс позволяет сторонним пользователям добавлять свои Telegram чаты для мониторинга через браузер. Система поддерживает мультитенантность: каждый пользователь видит только свои каналы и получает дайджесты в указанные места.

## Компоненты

### 1. База данных (PostgreSQL)

#### Таблица `users`
- Хранит пользователей веб-интерфейса
- Поля: `id`, `telegram_id`, `name`, `email`, `created_at`, `updated_at`, `is_active`

#### Таблица `web_channels`
- Хранит каналы добавленные через веб-интерфейс
- Поля: `id`, `user_id`, `telegram_chat_id`, `name`, `peer_type`, `enabled`, `recipient_telegram_id`, `created_at`, `updated_at`
- Связь с `users` через `user_id`

#### Модификация существующих таблиц
- Все таблицы (`tg.messages`, `tg.media`, `rpt.digests`, `vec.embeddings` и т.д.) получили поле `user_id`
- Индексы обновлены для фильтрации по `user_id`
- Существующие данные автоматически получают `user_id=1` (основной пользователь)

### 2. FastAPI Backend (`web_api.py`)

#### Endpoints:

**Frontend:**
- `GET /` - Главная страница с формой добавления канала
- `GET /channels` - Страница со списком каналов пользователя

**API:**
- `POST /api/users` - Создание/получение пользователя по Telegram ID
- `GET /api/channels?user_telegram_id=X` - Список каналов пользователя
- `POST /api/channels` - Добавление нового канала
  - Проверяет доступ к чату через Telethon
  - Создаёт запись в `web_channels`
  - Возвращает успех (загрузка истории произойдёт автоматически воркером)
- `DELETE /api/channels/{channel_id}?user_telegram_id=X` - Удаление канала
- `GET /api/digests/{channel_id}?user_telegram_id=X` - Получение дайджестов канала
- `GET /health` - Healthcheck

### 3. HTML Frontend

#### `index.html` - Форма добавления канала
- Поля:
  - Telegram ID пользователя (для идентификации)
  - Telegram ID чата для мониторинга
  - Название чата (опционально)
  - Telegram ID получателя дайджестов
  - Имя получателя (опционально)
- Валидация на клиенте
- AJAX отправка формы
- Отображение результатов (успех/ошибка)

#### `channels.html` - Список каналов
- Ввод Telegram ID пользователя
- Загрузка списка каналов через API
- Отображение:
  - Название и ID канала
  - Статус (активен/отключён)
  - Количество сообщений
  - Последний дайджест
  - Получатель
- Действия:
  - Просмотр дайджестов (заглушка)
  - Удаление канала

### 4. Интеграция с воркером

#### `config_db.py`
- Функция `load_channels_from_db()` - загружает каналы из БД
- Функция `merge_channels_from_sources()` - объединяет каналы из БД и `channels.json`
- Каналы из БД имеют приоритет (если есть дубликаты по ID)

#### Модификация `digest_worker.py`
- В `run_once()` вызывается `merge_channels_from_sources()` для загрузки каналов из БД
- В `process_channel()` извлекается `user_id` из канала
- Все вызовы методов БД передают `user_id`:
  - `db.get_last_msg_id(..., user_id=user_id)`
  - `db.upsert_message(..., user_id=user_id)`
  - `db.save_digest(..., user_id=user_id)`
  - `db.save_delivery(..., user_id=user_id)`
  - `db.update_last_msg_id(..., user_id=user_id)`

#### Модификация `database.py`
- Все методы принимают опциональный параметр `user_id`
- Если `user_id` не передан, система пытается определить его из БД или использует `user_id=1`
- Обратная совместимость: старые каналы из `channels.json` работают как раньше

## Поток работы

### Добавление нового канала:

1. Пользователь открывает `http://158.160.19.253/`
2. Заполняет форму:
   - Свой Telegram ID
   - ID чата для мониторинга
   - ID получателя дайджестов
3. Нажимает "Добавить канал"
4. Backend:
   - Создаёт/получает пользователя в БД
   - Проверяет доступ к чату через Telethon
   - Создаёт запись в `web_channels`
5. Воркер (при следующем цикле):
   - Загружает каналы из БД через `merge_channels_from_sources()`
   - Обрабатывает новый канал:
     - Загружает историю сообщений
     - Обрабатывает медиа через OCR
     - Создаёт сводный инженерный документ
     - Начинает отправлять дайджесты получателю

### Обработка канала воркером:

1. Воркер загружает каналы из БД и файла
2. Для каждого канала:
   - Получает `user_id` из канала
   - Загружает новые сообщения с фильтрацией по `user_id`
   - Сохраняет сообщения с `user_id`
   - Генерирует дайджесты
   - Отправляет получателям указанным в канале

## Безопасность

- **Изоляция данных:** Все запросы фильтруются по `user_id`
- **Проверка доступа:** Перед добавлением канала проверяется доступ через Telethon
- **Валидация:** Входные данные валидируются на сервере
- **Ошибки:** Детальные ошибки не раскрываются клиенту (только общие сообщения)

## Масштабирование

- Каждый пользователь изолирован через `user_id`
- Каналы загружаются динамически при каждом цикле воркера
- Новые каналы автоматически подхватываются без перезапуска сервиса
- Веб-интерфейс может работать на отдельном сервере (требуется доступ к БД и Telegram API)

## Ограничения

- Проверка доступа к чату синхронная (может быть медленной)
- Нет аутентификации (используется только Telegram ID)
- Нет управления правами доступа между пользователями
- История загружается постепенно (не мгновенно при добавлении)
